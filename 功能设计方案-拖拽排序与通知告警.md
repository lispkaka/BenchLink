# åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆï¼šæ‹–æ‹½æ’åº & CI/CD & é€šçŸ¥å‘Šè­¦

## ä¸€ã€æµ‹è¯•ç”¨ä¾‹æ‹–æ‹½æ’åºåŠŸèƒ½

### 1.1 éœ€æ±‚è¯´æ˜
- åœ¨æµ‹è¯•å¥—ä»¶ç¼–è¾‘é¡µé¢ï¼Œç”¨ä¾‹åˆ—è¡¨æ”¯æŒæ‹–æ‹½æ’åº
- æ‹–æ‹½åè‡ªåŠ¨ä¿å­˜æ–°çš„é¡ºåº
- ä¿æŒæ‰§è¡Œé¡ºåºä¸æ˜¾ç¤ºé¡ºåºä¸€è‡´

### 1.2 æŠ€æœ¯æ–¹æ¡ˆ
**å‰ç«¯å®ç°ï¼š**
- ä½¿ç”¨ `Sortable.js` æˆ– Vue åŸç”Ÿæ‹–æ‹½
- Element Plus çš„ `el-table` ç»“åˆæ‹–æ‹½åº“
- æ‹–æ‹½åè°ƒç”¨APIæ›´æ–°orderå­—æ®µ

**åç«¯å®ç°ï¼š**
- å·²æœ‰ `TestSuiteTestCase` æ¨¡å‹çš„ `order` å­—æ®µ
- æä¾›æ‰¹é‡æ›´æ–°orderçš„APIæ¥å£
- æ¥å£è·¯å¾„ï¼š`PATCH /api/testsuites/testsuites/{id}/reorder_testcases/`

**æ•°æ®æµç¨‹ï¼š**
```
ç”¨æˆ·æ‹–æ‹½ â†’ å‰ç«¯æ›´æ–°æœ¬åœ°é¡ºåº â†’ è°ƒç”¨APIæ‰¹é‡æ›´æ–° â†’ åç«¯ä¿å­˜æ–°order â†’ è¿”å›æˆåŠŸ
```

---

## äºŒã€CI/CD é›†æˆæ–¹æ¡ˆï¼ˆè½»é‡çº§ï¼‰

### 2.1 è®¾è®¡æ€è·¯
æä¾›**å‘½ä»¤è¡Œå·¥å…· + REST API**ï¼Œè®©ç”¨æˆ·åœ¨CI/CDæµç¨‹ä¸­è°ƒç”¨

### 2.2 åŠŸèƒ½æ¸…å•

#### 2.2.1 REST APIï¼ˆå·²æœ‰åŸºç¡€ï¼Œéœ€å¢å¼ºï¼‰
```python
# å·²æœ‰æ¥å£
POST /api/testsuites/testsuites/{id}/execute/  # æ‰§è¡Œå¥—ä»¶
GET  /api/executions/executions/{id}/          # è·å–æ‰§è¡Œç»“æœ

# éœ€è¦æ–°å¢
GET  /api/executions/executions/{id}/status/   # è½®è¯¢æ‰§è¡ŒçŠ¶æ€
GET  /api/executions/executions/{id}/wait/     # é˜»å¡ç­‰å¾…æ‰§è¡Œå®Œæˆï¼ˆè¶…æ—¶è¿”å›ï¼‰
```

#### 2.2.2 å‘½ä»¤è¡Œå·¥å…·ï¼ˆPythonè„šæœ¬ï¼‰
```bash
# åˆ›å»º backend/scripts/cicd_client.py
python cicd_client.py \
  --url http://localhost:8000 \
  --token YOUR_TOKEN \
  --suite-id 1 \
  --wait \
  --notify-on-fail
```

**åŠŸèƒ½ï¼š**
- è§¦å‘å¥—ä»¶æ‰§è¡Œ
- ç­‰å¾…æ‰§è¡Œå®Œæˆ
- æ ¹æ®ç»“æœè¿”å›é€€å‡ºç ï¼ˆ0=æˆåŠŸï¼Œ1=å¤±è´¥ï¼‰
- å¤±è´¥æ—¶è§¦å‘é€šçŸ¥

#### 2.2.3 Jenkins é›†æˆç¤ºä¾‹
```groovy
// Jenkinsfile
stage('APIæµ‹è¯•') {
    steps {
        sh '''
            python3 backend/scripts/cicd_client.py \
              --url ${API_TEST_URL} \
              --token ${API_TOKEN} \
              --suite-id ${TEST_SUITE_ID} \
              --wait \
              --notify-on-fail
        '''
    }
}
```

#### 2.2.4 GitLab CI é›†æˆç¤ºä¾‹
```yaml
# .gitlab-ci.yml
api_test:
  stage: test
  script:
    - python3 backend/scripts/cicd_client.py
        --url $API_TEST_URL
        --token $API_TOKEN
        --suite-id $TEST_SUITE_ID
        --wait
        --notify-on-fail
  only:
    - master
    - develop
```

#### 2.2.5 GitHub Actions é›†æˆç¤ºä¾‹
```yaml
# .github/workflows/api-test.yml
name: API Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run API Tests
        run: |
          python backend/scripts/cicd_client.py \
            --url ${{ secrets.API_TEST_URL }} \
            --token ${{ secrets.API_TOKEN }} \
            --suite-id 1 \
            --wait \
            --notify-on-fail
```

### 2.3 è®¤è¯æ–¹æ¡ˆ
- ä½¿ç”¨JWT Tokenè®¤è¯
- åœ¨ç”¨æˆ·è®¾ç½®é¡µé¢ç”ŸæˆAPI Token
- Tokenå­˜å‚¨åœ¨ç¯å¢ƒå˜é‡æˆ–CI/CDå¯†é’¥ä¸­

---

## ä¸‰ã€é€šçŸ¥å‘Šè­¦ç³»ç»Ÿè®¾è®¡

### 3.1 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµ‹è¯•æ‰§è¡Œå®Œæˆ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€šçŸ¥è§„åˆ™åˆ¤æ–­   â”‚ (æ˜¯å¦éœ€è¦é€šçŸ¥ï¼Ÿ)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¶ˆæ¯æ ¼å¼åŒ–     â”‚ (Markdownæ¨¡æ¿)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼             â–¼             â–¼             â–¼             â–¼
    ä¼ä¸šå¾®ä¿¡       é’‰é’‰æœºå™¨äºº    é£ä¹¦æœºå™¨äºº    Telegram    é‚®ä»¶
```

### 3.2 æ•°æ®æ¨¡å‹

```python
class NotificationChannel(models.Model):
    """é€šçŸ¥æ¸ é“é…ç½®"""
    name = models.CharField(max_length=100)
    channel_type = models.CharField(choices=[
        ('wecom', 'ä¼ä¸šå¾®ä¿¡'),
        ('dingtalk', 'é’‰é’‰'),
        ('feishu', 'é£ä¹¦'),
        ('telegram', 'Telegram'),
        ('email', 'é‚®ä»¶')
    ])
    webhook_url = models.URLField()  # æœºå™¨äººWebhook URL
    secret = models.CharField(blank=True)  # åŠ ç­¾å¯†é’¥ï¼ˆé’‰é’‰/é£ä¹¦ï¼‰
    is_active = models.BooleanField(default=True)
    project = models.ForeignKey(Project, null=True)  # é¡¹ç›®çº§åˆ«æˆ–å…¨å±€
    
    # é€šçŸ¥è§„åˆ™
    notify_on_success = models.BooleanField(default=False)
    notify_on_failure = models.BooleanField(default=True)
    notify_on_complete = models.BooleanField(default=False)
```

### 3.3 æ¶ˆæ¯æ¨¡æ¿

#### 3.3.1 ä¼ä¸šå¾®ä¿¡æ¶ˆæ¯ï¼ˆMarkdownï¼‰
```markdown
## ğŸ”” æµ‹è¯•æ‰§è¡Œé€šçŸ¥

**é¡¹ç›®ï¼š** CreatorX
**å¥—ä»¶ï¼š** ç§¯åˆ†ä»»åŠ¡
**çŠ¶æ€ï¼š** âœ… é€šè¿‡ / âŒ å¤±è´¥

---

### ğŸ“Š æ‰§è¡Œç»“æœ
- æ€»ç”¨ä¾‹æ•°ï¼š5
- é€šè¿‡ï¼š5
- å¤±è´¥ï¼š0
- é€šè¿‡ç‡ï¼š100%
- æ‰§è¡Œæ—¶é•¿ï¼š0.39s

### ğŸ”— æŸ¥çœ‹è¯¦æƒ…
[ç‚¹å‡»æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š](http://localhost:8080/executions/123)

æ‰§è¡Œäººï¼šadmin
æ‰§è¡Œæ—¶é—´ï¼š2025-11-05 11:14:48
```

#### 3.3.2 é’‰é’‰æ¶ˆæ¯ï¼ˆMarkdown + ActionCardï¼‰
```json
{
    "msgtype": "actionCard",
    "actionCard": {
        "title": "æµ‹è¯•æ‰§è¡Œé€šçŸ¥ - ç§¯åˆ†ä»»åŠ¡",
        "text": "## æ‰§è¡Œç»“æœ\né€šè¿‡ç‡ï¼š100%",
        "btnOrientation": "0",
        "singleTitle": "æŸ¥çœ‹è¯¦æƒ…",
        "singleURL": "http://localhost:8080/executions/123"
    }
}
```

#### 3.3.3 é£ä¹¦æ¶ˆæ¯ï¼ˆå¯Œæ–‡æœ¬å¡ç‰‡ï¼‰
```json
{
    "msg_type": "interactive",
    "card": {
        "header": {
            "title": {
                "content": "ğŸ”” æµ‹è¯•æ‰§è¡Œé€šçŸ¥",
                "tag": "plain_text"
            }
        },
        "elements": [...]
    }
}
```

#### 3.3.4 Telegramæ¶ˆæ¯
```markdown
ğŸ”” *æµ‹è¯•æ‰§è¡Œé€šçŸ¥*

é¡¹ç›®ï¼šCreatorX
å¥—ä»¶ï¼šç§¯åˆ†ä»»åŠ¡
çŠ¶æ€ï¼šâœ… é€šè¿‡

ğŸ“Š æ‰§è¡Œç»“æœ
â€¢ æ€»ç”¨ä¾‹æ•°ï¼š5
â€¢ é€šè¿‡ï¼š5 | å¤±è´¥ï¼š0
â€¢ é€šè¿‡ç‡ï¼š100%

[æŸ¥çœ‹è¯¦æƒ…](http://localhost:8080/executions/123)
```

### 3.4 å®ç°ç»†èŠ‚

#### 3.4.1 åç«¯å®ç°
```python
# apps/notifications/notifiers.py

class BaseNotifier:
    """é€šçŸ¥åŸºç±»"""
    def send(self, execution, channel):
        message = self.format_message(execution)
        self.do_send(message, channel)
    
    def format_message(self, execution):
        """æ ¼å¼åŒ–æ¶ˆæ¯"""
        pass
    
    def do_send(self, message, channel):
        """å‘é€æ¶ˆæ¯"""
        pass

class WeComNotifier(BaseNotifier):
    """ä¼ä¸šå¾®ä¿¡é€šçŸ¥"""
    def do_send(self, message, channel):
        requests.post(channel.webhook_url, json={
            "msgtype": "markdown",
            "markdown": {"content": message}
        })

class DingTalkNotifier(BaseNotifier):
    """é’‰é’‰é€šçŸ¥ï¼ˆæ”¯æŒåŠ ç­¾ï¼‰"""
    def do_send(self, message, channel):
        timestamp, sign = self.generate_sign(channel.secret)
        url = f"{channel.webhook_url}&timestamp={timestamp}&sign={sign}"
        requests.post(url, json={...})

# å…¶ä»–é€šçŸ¥å™¨ç±»ä¼¼å®ç°...
```

#### 3.4.2 è°ƒç”¨æ—¶æœº
```python
# apps/testsuites/views.py
def execute(self, request, pk=None):
    # ... æ‰§è¡Œæµ‹è¯• ...
    
    # æ‰§è¡Œå®Œæˆåè§¦å‘é€šçŸ¥
    from apps.notifications.service import send_execution_notification
    send_execution_notification(suite_execution)
    
    return Response({...})
```

#### 3.4.3 å‰ç«¯é…ç½®ç•Œé¢
- åœ¨é¡¹ç›®è®¾ç½®æˆ–å…¨å±€è®¾ç½®ä¸­é…ç½®é€šçŸ¥æ¸ é“
- è¡¨å•å­—æ®µï¼š
  - æ¸ é“åç§°
  - æ¸ é“ç±»å‹ï¼ˆä¸‹æ‹‰é€‰æ‹©ï¼‰
  - Webhook URL
  - åŠ ç­¾å¯†é’¥ï¼ˆå¯é€‰ï¼‰
  - é€šçŸ¥è§„åˆ™ï¼ˆæˆåŠŸ/å¤±è´¥/å®Œæˆï¼‰
  - å¯ç”¨çŠ¶æ€

### 3.5 è½»é‡çº§å®ç°ä¼˜å…ˆçº§

**ç¬¬ä¸€é˜¶æ®µï¼ˆæœ€å°å¯ç”¨ï¼‰ï¼š**
1. âœ… ä¼ä¸šå¾®ä¿¡é€šçŸ¥ï¼ˆæœ€å¸¸ç”¨ï¼‰
2. âœ… é’‰é’‰é€šçŸ¥ï¼ˆæœ€å¸¸ç”¨ï¼‰
3. âœ… ä»…æ”¯æŒå¤±è´¥é€šçŸ¥
4. âœ… å…¨å±€é…ç½®ï¼ˆä¸åŒºåˆ†é¡¹ç›®ï¼‰

**ç¬¬äºŒé˜¶æ®µï¼ˆåŠŸèƒ½å®Œå–„ï¼‰ï¼š**
5. é£ä¹¦é€šçŸ¥
6. Telegramé€šçŸ¥
7. æˆåŠŸ/å®Œæˆé€šçŸ¥é€‰é¡¹
8. é¡¹ç›®çº§åˆ«é…ç½®

**ç¬¬ä¸‰é˜¶æ®µï¼ˆé«˜çº§åŠŸèƒ½ï¼‰ï¼š**
9. @æŒ‡å®šäººå‘˜
10. è‡ªå®šä¹‰æ¶ˆæ¯æ¨¡æ¿
11. é™é»˜æ—¶æ®µè®¾ç½®
12. æ¶ˆæ¯å‘é€å†å²

---

## å››ã€å¼€å‘ä»»åŠ¡æ¸…å•

### 4.1 æ‹–æ‹½æ’åºåŠŸèƒ½
- [ ] åç«¯ï¼šæ–°å¢ `reorder_testcases` APIæ¥å£
- [ ] å‰ç«¯ï¼šå®‰è£… `sortablejs` ä¾èµ–
- [ ] å‰ç«¯ï¼šåœ¨æµ‹è¯•å¥—ä»¶ç¼–è¾‘é¡µé¢å®ç°æ‹–æ‹½
- [ ] æµ‹è¯•ï¼šéªŒè¯æ‹–æ‹½åæ‰§è¡Œé¡ºåºæ­£ç¡®

### 4.2 CI/CDé›†æˆ
- [ ] åç«¯ï¼šæ–°å¢ `wait` å’Œ `status` APIæ¥å£
- [ ] åˆ›å»º `cicd_client.py` å‘½ä»¤è¡Œå·¥å…·
- [ ] ç¼–å†™é›†æˆæ–‡æ¡£å’Œç¤ºä¾‹
- [ ] ç”¨æˆ·è®¾ç½®é¡µé¢æ·»åŠ API Tokenç®¡ç†

### 4.3 é€šçŸ¥å‘Šè­¦
- [ ] åˆ›å»º `notifications` app
- [ ] æ•°æ®æ¨¡å‹ï¼š`NotificationChannel`
- [ ] å®ç°é€šçŸ¥å™¨ï¼šä¼ä¸šå¾®ä¿¡ã€é’‰é’‰
- [ ] åœ¨æ‰§è¡Œå®Œæˆåè§¦å‘é€šçŸ¥
- [ ] å‰ç«¯ï¼šé€šçŸ¥æ¸ é“é…ç½®ç•Œé¢
- [ ] æµ‹è¯•ï¼šå‘é€æµ‹è¯•æ¶ˆæ¯

---

## äº”ã€é¢„ä¼°å·¥ä½œé‡

| åŠŸèƒ½ | åç«¯å·¥ä½œé‡ | å‰ç«¯å·¥ä½œé‡ | æ€»è®¡ |
|------|-----------|-----------|------|
| æ‹–æ‹½æ’åº | 1å°æ—¶ | 2å°æ—¶ | 3å°æ—¶ |
| CI/CDé›†æˆ | 2å°æ—¶ | 1å°æ—¶ | 3å°æ—¶ |
| é€šçŸ¥å‘Šè­¦ï¼ˆä¼ä¸šå¾®ä¿¡+é’‰é’‰ï¼‰ | 3å°æ—¶ | 2å°æ—¶ | 5å°æ—¶ |
| **æ€»è®¡** | **6å°æ—¶** | **5å°æ—¶** | **11å°æ—¶** |

---

## å…­ã€æŠ€æœ¯æ ˆ

- **æ‹–æ‹½æ’åºï¼š** Sortable.js + Vue3
- **HTTPè¯·æ±‚ï¼š** Python requests
- **æ¶ˆæ¯ç­¾åï¼š** hmac + hashlib
- **å¼‚æ­¥ä»»åŠ¡ï¼š** åŒæ­¥å®ç°ï¼ˆè½»é‡çº§ï¼‰
- **é…ç½®å­˜å‚¨ï¼š** Django ORM

---

## ä¸ƒã€å®‰å…¨è€ƒè™‘

1. **API Tokenå®‰å…¨ï¼š** 
   - Tokenå­˜å‚¨åœ¨CI/CDå¯†é’¥ç®¡ç†ä¸­
   - å®šæœŸè½®æ¢Token
   - æ”¯æŒTokenæ’¤é”€

2. **Webhookå®‰å…¨ï¼š**
   - é’‰é’‰/é£ä¹¦ä½¿ç”¨åŠ ç­¾éªŒè¯
   - HTTPSä¼ è¾“
   - æ•æ„Ÿä¿¡æ¯è„±æ•

3. **æƒé™æ§åˆ¶ï¼š**
   - é€šçŸ¥é…ç½®éœ€è¦adminæƒé™
   - APIè°ƒç”¨éœ€è¦è®¤è¯

---

## å…«ã€åç»­æ‰©å±•æ–¹å‘

1. **æ¶ˆæ¯é˜Ÿåˆ—ï¼š** ä½¿ç”¨Celeryå¤„ç†å¼‚æ­¥é€šçŸ¥
2. **é‡è¯•æœºåˆ¶ï¼š** é€šçŸ¥å¤±è´¥è‡ªåŠ¨é‡è¯•
3. **æ¶ˆæ¯èšåˆï¼š** æ‰¹é‡é€šçŸ¥é¿å…è½°ç‚¸
4. **æ›´å¤šæ¸ é“ï¼š** Slackã€Microsoft Teamsç­‰
5. **æ™ºèƒ½é€šçŸ¥ï¼š** åªåœ¨é‡è¦å˜åŒ–æ—¶é€šçŸ¥ï¼ˆå¤±è´¥ç‡ä¸Šå‡ã€æ–°å¢å¤±è´¥ç­‰ï¼‰

---

## ä¹ã€å¼€å§‹å¼€å‘

æŒ‰ç…§ä»¥ä¸‹é¡ºåºå¼€å‘ï¼š
1. **æ‹–æ‹½æ’åº**ï¼ˆæœ€ç®€å•ï¼Œå…ˆè§£å†³bugï¼‰
2. **é€šçŸ¥å‘Šè­¦-ä¼ä¸šå¾®ä¿¡**ï¼ˆæœ€å¸¸ç”¨ï¼Œä¼˜å…ˆï¼‰
3. **é€šçŸ¥å‘Šè­¦-é’‰é’‰**ï¼ˆæ¬¡å¸¸ç”¨ï¼‰
4. **CI/CDé›†æˆ**ï¼ˆæä¾›å‘½ä»¤è¡Œå·¥å…·ï¼‰
5. **é£ä¹¦ã€Telegram**ï¼ˆå¯é€‰ï¼Œçœ‹éœ€æ±‚ï¼‰

å‡†å¤‡å¥½äº†å—ï¼Ÿæˆ‘ä»¬ä»æ‹–æ‹½æ’åºå¼€å§‹ï¼





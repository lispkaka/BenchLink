# ä»£ç å®¡è®¡æŠ¥å‘Š

## å®¡è®¡æ—¶é—´
2024å¹´12æœˆ

## å®¡è®¡èŒƒå›´
- åç«¯ Django REST Framework API è§†å›¾
- æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå™¨
- æ€§èƒ½æµ‹è¯•æ‰§è¡Œå™¨
- æ•°æ®åº“æŸ¥è¯¢é€»è¾‘
- å‰ç«¯æ•°æ®å±•ç¤º

---

## ä¸€ã€å®‰å…¨æ€§é—®é¢˜

### ğŸ”´ é«˜å±é—®é¢˜

#### 1.1 ä»£ç æ‰§è¡Œé£é™©ï¼ˆexec() å‡½æ•°ï¼‰

**ä½ç½®ï¼š**
- `backend/apps/testcases/executor.py` (å¤šå¤„)
  - `_execute_pre_script()` (ç¬¬342è¡Œ)
  - `_execute_post_script()` (ç¬¬404è¡Œ)
  - `_execute_environment_pre_hook()` (ç¬¬435è¡Œ)
  - `_execute_environment_post_hook()` (ç¬¬479è¡Œ)
  - `_execute_manual_assertions()` (ç¬¬575è¡Œ)

**é—®é¢˜æè¿°ï¼š**
ä½¿ç”¨ `exec()` æ‰§è¡Œç”¨æˆ·è¾“å…¥çš„ Python è„šæœ¬ï¼Œè™½ç„¶é™åˆ¶äº† `__builtins__`ï¼Œä½†ä»ç„¶å­˜åœ¨å®‰å…¨é£é™©ï¼š

1. **æƒé™ç»•è¿‡é£é™©**ï¼šè™½ç„¶é™åˆ¶äº†å†…ç½®å‡½æ•°ï¼Œä½†é€šè¿‡ `setattr`ã€`getattr` ç­‰å‡½æ•°ä»å¯èƒ½è®¿é—®å—é™å¯¹è±¡
2. **èµ„æºè€—å°½é£é™©**ï¼šæ¶æ„è„šæœ¬å¯èƒ½å¯¼è‡´æ— é™å¾ªç¯æˆ–å¤§é‡å†…å­˜å ç”¨
3. **æ•æ„Ÿä¿¡æ¯æ³„éœ²**ï¼šè„šæœ¬å¯ä»¥è®¿é—® `variables`ã€`testcase`ã€`api`ã€`environment` ç­‰å¯¹è±¡ï¼Œå¯èƒ½æ³„éœ²æ•æ„Ÿé…ç½®

**é£é™©ç­‰çº§ï¼š** ğŸ”´ é«˜å±

**å»ºè®®ä¿®å¤ï¼š**
```python
# æ–¹æ¡ˆ1ï¼šä½¿ç”¨æ›´å®‰å…¨çš„æ‰§è¡Œç¯å¢ƒï¼ˆæ¨èï¼‰
import RestrictedPython
from RestrictedPython import compile_restricted, safe_globals
from RestrictedPython.Guards import safe_builtins

def _execute_script_safely(self, script: str, context: dict) -> dict:
    """å®‰å…¨æ‰§è¡Œè„šæœ¬"""
    # é™åˆ¶è„šæœ¬æ‰§è¡Œæ—¶é—´
    import signal
    
    def timeout_handler(signum, frame):
        raise TimeoutError("è„šæœ¬æ‰§è¡Œè¶…æ—¶")
    
    # è®¾ç½®è¶…æ—¶ï¼ˆä¾‹å¦‚5ç§’ï¼‰
    signal.signal(signal.SIGALRM, timeout_handler)
    signal.alarm(5)
    
    try:
        # ä½¿ç”¨ RestrictedPython ç¼–è¯‘å’Œæ‰§è¡Œ
        byte_code = compile_restricted(script, '<inline>', 'exec')
        if byte_code.errors:
            raise ValueError(f"è„šæœ¬ç¼–è¯‘é”™è¯¯: {byte_code.errors}")
        
        # å®‰å…¨çš„å…¨å±€å˜é‡
        restricted_globals = safe_globals.copy()
        restricted_globals.update({
            'len': len, 'str': str, 'int': int, 'float': float,
            'print': print,  # é™åˆ¶printè¡Œä¸º
        })
        
        exec(byte_code.code, restricted_globals, context)
    finally:
        signal.alarm(0)  # å–æ¶ˆè¶…æ—¶

# æ–¹æ¡ˆ2ï¼šæ·»åŠ è„šæœ¬ç™½åå•æœºåˆ¶
ALLOWED_SCRIPT_PATTERNS = [
    r'^set_variable\(',  # åªå…è®¸è®¾ç½®å˜é‡
    r'^get_variable\(',  # åªå…è®¸è·å–å˜é‡
    # ... å…¶ä»–å®‰å…¨æ¨¡å¼
]

def _validate_script(self, script: str) -> bool:
    """éªŒè¯è„šæœ¬æ˜¯å¦å®‰å…¨"""
    import ast
    try:
        tree = ast.parse(script)
        # æ£€æŸ¥æ˜¯å¦åŒ…å«å±é™©æ“ä½œ
        for node in ast.walk(tree):
            if isinstance(node, ast.Import):
                return False  # ç¦æ­¢å¯¼å…¥
            if isinstance(node, ast.Call):
                if isinstance(node.func, ast.Name):
                    if node.func.id in ['open', 'eval', 'exec', '__import__']:
                        return False
        return True
    except SyntaxError:
        return False
```

#### 1.2 å‘½ä»¤æ³¨å…¥é£é™©ï¼ˆsubprocessï¼‰

**ä½ç½®ï¼š**
- `backend/apps/testcases/locust_executor.py` (ç¬¬278è¡Œ)

**é—®é¢˜æè¿°ï¼š**
ä½¿ç”¨ `subprocess.run()` æ‰§è¡Œ Locust å‘½ä»¤ï¼Œè™½ç„¶å‚æ•°æ˜¯ç¡¬ç¼–ç çš„ï¼Œä½†å¦‚æœ `locust_file` è·¯å¾„è¢«æ¶æ„æ„é€ ï¼Œä»å¯èƒ½å­˜åœ¨é—®é¢˜ã€‚

**é£é™©ç­‰çº§ï¼š** ğŸŸ¡ ä¸­ç­‰

**å½“å‰ä»£ç ï¼š**
```python
result = subprocess.run(
    cmd,
    capture_output=True,
    text=True,
    timeout=timeout_seconds
)
```

**å»ºè®®ä¿®å¤ï¼š**
```python
# ä½¿ç”¨ shlex.quote è½¬ä¹‰å‚æ•°
import shlex

# ç¡®ä¿æ‰€æœ‰å‚æ•°éƒ½è¢«æ­£ç¡®è½¬ä¹‰
cmd = [
    'locust',
    '-f', shlex.quote(locust_file),
    '--headless',
    # ... å…¶ä»–å‚æ•°
]

# æˆ–è€…ä½¿ç”¨ Path å¯¹è±¡å¹¶éªŒè¯
from pathlib import Path
locust_file_path = Path(locust_file)
if not locust_file_path.exists() or not locust_file_path.is_file():
    raise ValueError("Locust è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸æ˜¯æœ‰æ•ˆæ–‡ä»¶")

# éªŒè¯æ–‡ä»¶åœ¨å…è®¸çš„ç›®å½•å†…
allowed_dir = Path(settings.BASE_DIR) / 'logs' / 'locust'
if not locust_file_path.resolve().is_relative_to(allowed_dir.resolve()):
    raise ValueError("Locust è„šæœ¬æ–‡ä»¶è·¯å¾„ä¸åœ¨å…è®¸çš„ç›®å½•å†…")
```

#### 1.3 æƒé™æ§åˆ¶ä¸è¶³

**ä½ç½®ï¼š**
- `backend/apps/executions/views.py` - ExecutionViewSet
- `backend/apps/testcases/views.py` - TestCaseViewSet
- `backend/apps/testsuites/views.py` - TestSuiteViewSet
- `backend/apps/apis/views.py` - APIViewSet

**é—®é¢˜æè¿°ï¼š**
è¿™äº› ViewSet ç»§æ‰¿äº† `ModelViewSet`ï¼Œä½†æ²¡æœ‰æ˜ç¡®è®¾ç½® `permission_classes`ï¼Œå¯èƒ½ä¾èµ–å…¨å±€é»˜è®¤æƒé™ã€‚éœ€è¦ç¡®ä¿ï¼š
1. åˆ›å»º/æ›´æ–°/åˆ é™¤æ“ä½œéœ€è¦è®¤è¯
2. ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±é¡¹ç›®çš„èµ„æº
3. æ‰¹é‡åˆ é™¤æ“ä½œéœ€è¦æƒé™éªŒè¯

**é£é™©ç­‰çº§ï¼š** ğŸŸ¡ ä¸­ç­‰

**å»ºè®®ä¿®å¤ï¼š**
```python
from rest_framework.permissions import IsAuthenticated
from rest_framework.decorators import action

class ExecutionViewSet(viewsets.ModelViewSet):
    permission_classes = [IsAuthenticated]  # æ˜ç¡®è¦æ±‚è®¤è¯
    
    def get_queryset(self):
        # æ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤
        queryset = Execution.objects.all()
        if not self.request.user.is_superuser:
            # æ™®é€šç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±é¡¹ç›®çš„æ‰§è¡Œè®°å½•
            queryset = queryset.filter(project__members=self.request.user)
        return queryset
    
    @action(detail=False, methods=['post'])
    def batch_delete(self, request):
        """æ‰¹é‡åˆ é™¤æ‰§è¡Œè®°å½•"""
        # éªŒè¯æƒé™
        if not request.user.is_authenticated:
            return Response({'error': 'éœ€è¦è®¤è¯'}, status=status.HTTP_401_UNAUTHORIZED)
        
        execution_ids = request.data.get('ids', [])
        if not execution_ids:
            return Response({'error': 'è¯·æä¾›è¦åˆ é™¤çš„æ‰§è¡Œè®°å½•IDåˆ—è¡¨'}, 
                          status=status.HTTP_400_BAD_REQUEST)
        
        # é™åˆ¶æ‰¹é‡åˆ é™¤æ•°é‡ï¼Œé˜²æ­¢DoS
        if len(execution_ids) > 100:
            return Response({'error': 'ä¸€æ¬¡æœ€å¤šåªèƒ½åˆ é™¤100æ¡è®°å½•'}, 
                          status=status.HTTP_400_BAD_REQUEST)
        
        # éªŒè¯IDç±»å‹
        try:
            execution_ids = [int(id) for id in execution_ids]
        except (ValueError, TypeError):
            return Response({'error': 'IDæ ¼å¼ä¸æ­£ç¡®'}, status=status.HTTP_400_BAD_REQUEST)
        
        # åªåˆ é™¤ç”¨æˆ·æœ‰æƒé™çš„è®°å½•
        executions = Execution.objects.filter(
            id__in=execution_ids,
            project__members=request.user  # æƒé™è¿‡æ»¤
        )
        
        deleted_count = executions.count()
        executions.delete()
        
        return Response({
            'message': f'æˆåŠŸåˆ é™¤ {deleted_count} æ¡æ‰§è¡Œè®°å½•',
            'deleted_count': deleted_count
        }, status=status.HTTP_200_OK)
```

#### 1.4 XSS é£é™©ï¼ˆè·¨ç«™è„šæœ¬æ”»å‡»ï¼‰

**ä½ç½®ï¼š**
- `frontend/src/views/dashboard/ApiDashboard.vue` - æ˜¾ç¤ºæ‰§è¡Œç»“æœ
- `backend/apps/executions/views.py` - è¿”å›æ‰§è¡Œç»“æœ

**é—®é¢˜æè¿°ï¼š**
æ‰§è¡Œç»“æœä¸­åŒ…å«ç”¨æˆ·è¾“å…¥çš„URLã€headersã€bodyç­‰æ•°æ®ï¼Œå¦‚æœç›´æ¥åœ¨å‰ç«¯æ¸²æŸ“ï¼Œå¯èƒ½å­˜åœ¨XSSé£é™©ã€‚

**é£é™©ç­‰çº§ï¼š** ğŸŸ¡ ä¸­ç­‰

**å»ºè®®ä¿®å¤ï¼š**
1. **åç«¯ï¼š** å¯¹æ•æ„Ÿæ•°æ®è¿›è¡Œæ¸…ç†æˆ–è½¬ä¹‰
2. **å‰ç«¯ï¼š** ä½¿ç”¨ `v-text` æˆ– `{{ }}` æ—¶ Vue ä¼šè‡ªåŠ¨è½¬ä¹‰ï¼Œä½†ä½¿ç”¨ `v-html` æ—¶éœ€è¦è°¨æ…

```vue
<!-- å‰ç«¯ï¼šé¿å…ç›´æ¥ä½¿ç”¨ v-html -->
<!-- é”™è¯¯ç¤ºä¾‹ -->
<div v-html="execution.result.body"></div>

<!-- æ­£ç¡®ç¤ºä¾‹ -->
<div v-text="execution.result.body"></div>
<!-- æˆ–è€…ä½¿ç”¨DOMPurifyæ¸…ç†HTML -->
<div v-html="sanitizeHtml(execution.result.body)"></div>
```

```python
# åç«¯ï¼šå¯¹è¿”å›çš„æ•æ„Ÿæ•°æ®è¿›è¡Œæ¸…ç†
import bleach

def sanitize_response_data(data):
    """æ¸…ç†å“åº”æ•°æ®ä¸­çš„æ½œåœ¨XSSå†…å®¹"""
    if isinstance(data, dict):
        return {k: sanitize_response_data(v) for k, v in data.items()}
    elif isinstance(data, list):
        return [sanitize_response_data(item) for item in data]
    elif isinstance(data, str):
        # å¦‚æœæ•°æ®æ˜¯HTMLï¼Œä½¿ç”¨bleachæ¸…ç†
        # å¦‚æœåªæ˜¯æ™®é€šæ–‡æœ¬ï¼Œå¯ä»¥ä¿ç•™åŸæ ·ï¼ˆå‰ç«¯ä¼šè½¬ä¹‰ï¼‰
        return data
    return data
```

#### 1.5 è¾“å…¥éªŒè¯ä¸è¶³

**ä½ç½®ï¼š**
- `backend/apps/executions/views.py` - dashboard() æ–¹æ³• (ç¬¬46è¡Œ)

**é—®é¢˜æè¿°ï¼š**
`hours` å‚æ•°ç›´æ¥è½¬æ¢ä¸º `int`ï¼Œæ²¡æœ‰éªŒè¯èŒƒå›´ï¼Œå¯èƒ½å¯¼è‡´ï¼š
1. è´Ÿæ•°å¯¼è‡´æ—¶é—´è®¡ç®—é”™è¯¯
2. è¿‡å¤§çš„å€¼å¯¼è‡´æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½é—®é¢˜

**é£é™©ç­‰çº§ï¼š** ğŸŸ¡ ä¸­ç­‰

**å»ºè®®ä¿®å¤ï¼š**
```python
@action(detail=False, methods=['get'])
def dashboard(self, request):
    """ä»ªè¡¨ç›˜ç»Ÿè®¡æ•°æ®"""
    # è·å–å¹¶éªŒè¯æ—¶é—´èŒƒå›´å‚æ•°
    try:
        hours = int(request.query_params.get('hours', 24))
        # é™åˆ¶èŒƒå›´ï¼š1å°æ—¶åˆ°30å¤©
        if hours < 1:
            hours = 1
        elif hours > 720:  # 30å¤©
            hours = 720
    except (ValueError, TypeError):
        hours = 24  # é»˜è®¤å€¼
    
    time_start = timezone.now() - timedelta(hours=hours)
    # ... å…¶ä½™ä»£ç 
```

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜

#### 1.6 SSL éªŒè¯è¢«ç¦ç”¨

**ä½ç½®ï¼š**
- `backend/apps/testcases/executor.py` (ç¬¬14-15è¡Œ)
- `backend/apps/testcases/executor.py` (ç¬¬756è¡Œ)

**é—®é¢˜æè¿°ï¼š**
ä»£ç ä¸­ç¦ç”¨äº† SSL éªŒè¯ï¼Œè¿™åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å­˜åœ¨ä¸­é—´äººæ”»å‡»é£é™©ã€‚

**é£é™©ç­‰çº§ï¼š** ğŸŸ¡ ä¸­ç­‰

**å»ºè®®ä¿®å¤ï¼š**
```python
# æ ¹æ®ç¯å¢ƒå˜é‡å†³å®šæ˜¯å¦éªŒè¯SSL
import os
VERIFY_SSL = os.getenv('VERIFY_SSL', 'True').lower() == 'true'

request_kwargs = {
    'method': self.api.method,
    'url': url,
    'headers': headers,
    'params': params,
    'timeout': 30,
    'verify': VERIFY_SSL  # ç”Ÿäº§ç¯å¢ƒåº”è¯¥å¯ç”¨
}
```

#### 1.7 æ–‡ä»¶è·¯å¾„å®‰å…¨

**ä½ç½®ï¼š**
- `backend/apps/testcases/locust_executor.py` - HTMLæŠ¥å‘Šæ–‡ä»¶è®¿é—®

**é—®é¢˜æè¿°ï¼š**
`html_report()` æ–¹æ³•ç›´æ¥ä½¿ç”¨ç”¨æˆ·æä¾›çš„è·¯å¾„è®¿é—®æ–‡ä»¶ï¼Œå¯èƒ½å­˜åœ¨è·¯å¾„éå†é£é™©ã€‚

**é£é™©ç­‰çº§ï¼š** ğŸŸ¡ ä¸­ç­‰

**å½“å‰ä»£ç ï¼š**
```python
@action(detail=True, methods=['get'])
def html_report(self, request, pk=None):
    html_report_path = performance_test.last_result.get('html_report')
    report_file = Path(html_report_path)  # å¯èƒ½ä¸å®‰å…¨
```

**å»ºè®®ä¿®å¤ï¼š**
```python
# éªŒè¯æ–‡ä»¶è·¯å¾„åœ¨å…è®¸çš„ç›®å½•å†…
allowed_dir = Path(settings.BASE_DIR) / 'logs' / 'locust'
report_file = Path(html_report_path)

# ç¡®ä¿è·¯å¾„åœ¨å…è®¸çš„ç›®å½•å†…
if not report_file.resolve().is_relative_to(allowed_dir.resolve()):
    raise ValueError("æ–‡ä»¶è·¯å¾„ä¸åœ¨å…è®¸çš„ç›®å½•å†…")
```

---

## äºŒã€é€»è¾‘é”™è¯¯

### 2.1 é™¤é›¶é”™è¯¯é£é™©

**ä½ç½®ï¼š**
- `backend/apps/executions/views.py` (ç¬¬61è¡Œ)
- `backend/apps/testsuites/views.py` (ç¬¬247è¡Œ)

**é—®é¢˜æè¿°ï¼š**
è®¡ç®—é€šè¿‡ç‡æ—¶ï¼Œå¦‚æœ `total_today` ä¸º 0ï¼Œè™½ç„¶ä»£ç ä¸­æœ‰æ£€æŸ¥ï¼Œä½†é€»è¾‘ä¸å¤Ÿæ¸…æ™°ã€‚

**å½“å‰ä»£ç ï¼š**
```python
pass_rate = round((passed_today / total_today * 100), 2) if total_today > 0 else 0
```

**å»ºè®®ï¼š** ä»£ç å·²æ­£ç¡®å¤„ç†ï¼Œä½†å¯ä»¥æ›´æ˜ç¡®ï¼š
```python
if total_today > 0:
    pass_rate = round((passed_today / total_today * 100), 2)
else:
    pass_rate = 0.0
```

### 2.2 å‚æ•°åŒ–æ•°æ®éªŒè¯ä¸è¶³

**ä½ç½®ï¼š**
- `backend/apps/testcases/views.py` - execute() æ–¹æ³•

**é—®é¢˜æè¿°ï¼š**
å‚æ•°åŒ–æ•°æ®æ²¡æœ‰éªŒè¯ï¼š
1. æ•°æ®ç±»å‹æ˜¯å¦æ­£ç¡®
2. æ•°æ®é¡¹æ•°é‡æ˜¯å¦åˆç†ï¼ˆé˜²æ­¢DoSï¼‰
3. å˜é‡åæ˜¯å¦åˆæ³•

**å»ºè®®ä¿®å¤ï¼š**
```python
# éªŒè¯å‚æ•°åŒ–æ•°æ®
if parameterized_mode == 'enabled' and parameterized_data:
    if not isinstance(parameterized_data, list):
        return Response({'error': 'å‚æ•°åŒ–æ•°æ®å¿…é¡»æ˜¯åˆ—è¡¨'}, 
                      status=http_status.HTTP_400_BAD_REQUEST)
    
    # é™åˆ¶å‚æ•°åŒ–æ•°æ®æ•°é‡ï¼Œé˜²æ­¢DoS
    if len(parameterized_data) > 100:
        return Response({'error': 'å‚æ•°åŒ–æ•°æ®æœ€å¤š100æ¡'}, 
                      status=http_status.HTTP_400_BAD_REQUEST)
    
    # éªŒè¯æ¯ä¸ªæ•°æ®é¡¹
    for idx, param_set in enumerate(parameterized_data):
        if not isinstance(param_set, dict):
            return Response({'error': f'å‚æ•°åŒ–æ•°æ®é¡¹ #{idx+1} å¿…é¡»æ˜¯å­—å…¸'}, 
                          status=http_status.HTTP_400_BAD_REQUEST)
        
        # éªŒè¯å˜é‡åï¼ˆåªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼‰
        import re
        for var_name in param_set.keys():
            if not re.match(r'^[a-zA-Z_][a-zA-Z0-9_]*$', var_name):
                return Response({'error': f'å˜é‡å "{var_name}" ä¸åˆæ³•'}, 
                              status=http_status.HTTP_400_BAD_REQUEST)
```

### 2.3 æ—¶é—´è®¡ç®—ç²¾åº¦é—®é¢˜

**ä½ç½®ï¼š**
- `backend/apps/testcases/views.py` - execute() æ–¹æ³•

**é—®é¢˜æè¿°ï¼š**
ä½¿ç”¨ `timezone.now()` è®¡ç®—è€—æ—¶ï¼Œåœ¨é«˜å¹¶å‘æƒ…å†µä¸‹å¯èƒ½å­˜åœ¨ç²¾åº¦é—®é¢˜ã€‚

**å»ºè®®ï¼š** ä½¿ç”¨ `time.perf_counter()` æˆ– `time.process_time()` è·å–æ›´ç²¾ç¡®çš„æ—¶é—´ï¼š
```python
import time

start_time_perf = time.perf_counter()
# ... æ‰§è¡Œä»£ç 
end_time_perf = time.perf_counter()
duration = end_time_perf - start_time_perf
```

---

## ä¸‰ã€æ€§èƒ½é—®é¢˜

### 3.1 N+1 æŸ¥è¯¢é—®é¢˜

**ä½ç½®ï¼š**
- `backend/apps/executions/views.py` - dashboard() æ–¹æ³• (ç¬¬110-120è¡Œ)

**é—®é¢˜æè¿°ï¼š**
åœ¨å¾ªç¯ä¸­è®¿é—®å…³è”å¯¹è±¡ï¼Œå¯¼è‡´N+1æŸ¥è¯¢ï¼š
```python
for run in recent_runs:
    recent_runs_data.append({
        'suite': run.testsuite.name if run.testsuite else ...,
        'testcase': run.testcase.name if run.testcase else ...,
        'env': run.testsuite.environment.name if ...,
    })
```

**å»ºè®®ä¿®å¤ï¼š**
```python
# ä½¿ç”¨ select_related å’Œ prefetch_related ä¼˜åŒ–æŸ¥è¯¢
recent_runs = Execution.objects.filter(
    created_at__gte=time_start
).select_related(
    'testsuite',
    'testsuite__environment',
    'testcase',
    'testcase__project'
).order_by('-created_at')[:10]
```

### 3.2 é‡å¤æŸ¥è¯¢ç»Ÿè®¡

**ä½ç½®ï¼š**
- `backend/apps/testcases/views.py` - statistics() æ–¹æ³• (ç¬¬256è¡Œ)

**é—®é¢˜æè¿°ï¼š**
åœ¨å¾ªç¯ä¸­å¯¹æ¯ä¸ªç”¨ä¾‹æ‰§è¡ŒæŸ¥è¯¢ï¼Œæ•ˆç‡ä½ä¸‹ï¼š
```python
for testcase in TestCase.objects.all():
    latest_execution = Execution.objects.filter(testcase=testcase).order_by('-created_at').first()
```

**å»ºè®®ä¿®å¤ï¼š**
```python
# ä½¿ç”¨èšåˆæŸ¥è¯¢ä¸€æ¬¡æ€§è·å–æ‰€æœ‰ç”¨ä¾‹çš„æœ€æ–°æ‰§è¡ŒçŠ¶æ€
from django.db.models import OuterRef, Subquery

latest_executions = Execution.objects.filter(
    testcase=OuterRef('pk')
).order_by('-created_at')

testcases_with_status = TestCase.objects.annotate(
    latest_status=Subquery(latest_executions.values('status')[:1])
).values('latest_status')

passed_count = testcases_with_status.filter(latest_status='passed').count()
failed_count = testcases_with_status.filter(latest_status='failed').count()
```

### 3.3 æ•°æ®åº“æŸ¥è¯¢æœªä½¿ç”¨ç´¢å¼•

**ä½ç½®ï¼š**
- `backend/apps/executions/views.py` - dashboard() æ–¹æ³•

**é—®é¢˜æè¿°ï¼š**
é¢‘ç¹ä½¿ç”¨ `created_at__gte` å’Œ `status` è¿‡æ»¤ï¼Œéœ€è¦ç¡®ä¿è¿™äº›å­—æ®µæœ‰ç´¢å¼•ã€‚

**å»ºè®®ï¼š**
åœ¨ `Execution` æ¨¡å‹ä¸Šæ·»åŠ æ•°æ®åº“ç´¢å¼•ï¼š
```python
class Execution(models.Model):
    # ... å­—æ®µå®šä¹‰
    
    class Meta:
        indexes = [
            models.Index(fields=['created_at', 'status']),
            models.Index(fields=['testcase', 'created_at']),
            models.Index(fields=['status', 'parent']),
        ]
```

### 3.4 Flakyç”¨ä¾‹è®¡ç®—æ€§èƒ½

**ä½ç½®ï¼š**
- `backend/apps/executions/views.py` - dashboard() æ–¹æ³• (ç¬¬149-166è¡Œ)

**é—®é¢˜æè¿°ï¼š**
åœ¨å¾ªç¯ä¸­æ‰§è¡Œå¤šæ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼Œæ•ˆç‡ä½ã€‚

**å»ºè®®ä¿®å¤ï¼š**
```python
# ä½¿ç”¨èšåˆæŸ¥è¯¢ä¸€æ¬¡æ€§è®¡ç®—
from django.db.models import Count, Q, Avg

seven_days_ago = timezone.now() - timedelta(days=7)

# ä¸€æ¬¡æ€§è·å–æ‰€æœ‰ç”¨ä¾‹çš„ç»Ÿè®¡ä¿¡æ¯
case_stats = Execution.objects.filter(
    created_at__gte=seven_days_ago,
    testcase__isnull=False
).values('testcase').annotate(
    total_count=Count('id'),
    failed_count=Count('id', filter=Q(status='failed')),
    avg_duration=Avg('duration')
).filter(
    total_count__gte=3  # è‡³å°‘æ‰§è¡Œ3æ¬¡
).annotate(
    failure_rate=Count('id', filter=Q(status='failed')) * 100.0 / Count('id')
).filter(
    failure_rate__gt=20  # å¤±è´¥ç‡è¶…è¿‡20%
).order_by('-failure_rate')[:5]

flaky_cases = []
for stat in case_stats:
    testcase = TestCase.objects.get(id=stat['testcase'])
    failure_rate = stat['failure_rate']
    flaky_cases.append({
        'name': testcase.name,
        'desc': f'æœ€è¿‘ {stat["total_count"]} æ¬¡ï¼šå¤±è´¥ {stat["failed_count"]} æ¬¡ Â· å¹³å‡è€—æ—¶ {round(stat["avg_duration"] or 0, 1)}s',
        'risk': 'é«˜é£é™©' if failure_rate > 50 else 'ä¸­ç­‰',
        'type': 'danger' if failure_rate > 50 else 'warning'
    })
```

### 3.5 è¶‹åŠ¿æ•°æ®å¾ªç¯æŸ¥è¯¢

**ä½ç½®ï¼š**
- `backend/apps/executions/views.py` - dashboard() æ–¹æ³• (ç¬¬72-86è¡Œ)

**é—®é¢˜æè¿°ï¼š**
åœ¨å¾ªç¯ä¸­æ‰§è¡Œå¤šæ¬¡æ•°æ®åº“æŸ¥è¯¢ã€‚

**å»ºè®®ä¿®å¤ï¼š**
```python
# ä½¿ç”¨ä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰æ•°æ®ï¼Œç„¶ååœ¨å†…å­˜ä¸­åˆ†ç»„
from django.db.models import Count
from django.db.models.functions import TruncHour

hour_executions = Execution.objects.filter(
    created_at__gte=time_start,
    parent__isnull=True
).annotate(
    hour=TruncHour('created_at')
).values('hour').annotate(
    runs=Count('id'),
    failures=Count('id', filter=Q(status='failed'))
).order_by('hour')

# è½¬æ¢ä¸ºå­—å…¸ä¾¿äºæŸ¥æ‰¾
hour_data = {item['hour']: item for item in hour_executions}

# å¡«å……æ‰€æœ‰å°æ—¶çš„æ•°æ®
trend_data = []
for i in range(hours):
    hour_start = time_start + timedelta(hours=i)
    hour_key = hour_start.replace(minute=0, second=0, microsecond=0)
    
    data = hour_data.get(hour_key, {'runs': 0, 'failures': 0})
    trend_data.append({
        'name': f'{hour_start.hour}h',
        'runs': data['runs'],
        'failures': data['failures']
    })
```

---

## å››ã€å…¶ä»–å»ºè®®

### 4.1 æ·»åŠ æ—¥å¿—è®°å½•

å»ºè®®åœ¨å…³é”®æ“ä½œå¤„æ·»åŠ æ—¥å¿—ï¼š
```python
import logging
logger = logging.getLogger(__name__)

@action(detail=False, methods=['post'])
def batch_delete(self, request):
    logger.info(f"ç”¨æˆ· {request.user.username} æ‰¹é‡åˆ é™¤æ‰§è¡Œè®°å½•: {execution_ids}")
    # ... æ‰§è¡Œåˆ é™¤
    logger.info(f"æˆåŠŸåˆ é™¤ {deleted_count} æ¡è®°å½•")
```

### 4.2 æ·»åŠ è¯·æ±‚é™æµ

é˜²æ­¢APIè¢«æ»¥ç”¨ï¼š
```python
from rest_framework.throttling import UserRateThrottle

class ExecutionViewSet(viewsets.ModelViewSet):
    throttle_classes = [UserRateThrottle]
    throttle_scope = 'executions'  # åœ¨settings.pyä¸­é…ç½®é€Ÿç‡
```

### 4.3 æ·»åŠ æ•°æ®éªŒè¯ä¸­é—´ä»¶

å»ºè®®ä½¿ç”¨ DRF çš„åºåˆ—åŒ–å™¨è¿›è¡Œä¸¥æ ¼çš„æ•°æ®éªŒè¯ã€‚

### 4.4 ç¯å¢ƒå˜é‡ç®¡ç†

ç¡®ä¿æ•æ„Ÿé…ç½®ï¼ˆå¦‚ SECRET_KEYã€æ•°æ®åº“å¯†ç ï¼‰é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†ï¼Œä¸è¦ç¡¬ç¼–ç ã€‚

---

## äº”ã€ä¼˜å…ˆçº§ä¿®å¤å»ºè®®

### ç«‹å³ä¿®å¤ï¼ˆé«˜å±ï¼‰
1. âœ… **ä»£ç æ‰§è¡Œé£é™©ï¼ˆexecï¼‰** - ä½¿ç”¨ RestrictedPython æˆ–é™åˆ¶è„šæœ¬åŠŸèƒ½
2. âœ… **æƒé™æ§åˆ¶** - æ·»åŠ æ˜ç¡®çš„æƒé™æ£€æŸ¥å’Œé¡¹ç›®çº§æƒé™æ§åˆ¶
3. âœ… **è¾“å…¥éªŒè¯** - éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥ï¼Œé™åˆ¶èŒƒå›´

### è¿‘æœŸä¿®å¤ï¼ˆä¸­å±ï¼‰
1. âœ… **å‘½ä»¤æ³¨å…¥** - éªŒè¯æ–‡ä»¶è·¯å¾„ï¼Œä½¿ç”¨ shlex.quote
2. âœ… **XSSé£é™©** - å‰ç«¯æ­£ç¡®è½¬ä¹‰ï¼Œåç«¯æ¸…ç†æ•°æ®
3. âœ… **SSLéªŒè¯** - ç”Ÿäº§ç¯å¢ƒå¯ç”¨SSLéªŒè¯
4. âœ… **æ€§èƒ½ä¼˜åŒ–** - ä¿®å¤N+1æŸ¥è¯¢é—®é¢˜

### é•¿æœŸä¼˜åŒ–
1. âœ… æ·»åŠ å®Œæ•´çš„å®¡è®¡æ—¥å¿—
2. âœ… å®æ–½è¯·æ±‚é™æµ
3. âœ… æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
4. âœ… ä»£ç å®¡æŸ¥æµç¨‹

---

## å…­ã€æ€»ç»“

æœ¬æ¬¡å®¡è®¡å…±å‘ç°ï¼š
- ğŸ”´ **é«˜å±é—®é¢˜**: 4ä¸ª
- ğŸŸ¡ **ä¸­ç­‰é—®é¢˜**: 6ä¸ª
- ğŸŸ¢ **å»ºè®®ä¼˜åŒ–**: 8ä¸ª

**æ€»ä½“è¯„ä»·ï¼š**
ä»£ç æ•´ä½“ç»“æ„è‰¯å¥½ï¼Œä½¿ç”¨äº† Django ORM é¿å…äº†å¤§éƒ¨åˆ† SQL æ³¨å…¥é£é™©ï¼Œä½†åœ¨ä»£ç æ‰§è¡Œã€æƒé™æ§åˆ¶å’Œæ€§èƒ½ä¼˜åŒ–æ–¹é¢éœ€è¦åŠ å¼ºã€‚å»ºè®®ä¼˜å…ˆä¿®å¤é«˜å±å®‰å…¨é—®é¢˜ï¼Œç„¶åé€æ­¥ä¼˜åŒ–æ€§èƒ½å’Œä»£ç è´¨é‡ã€‚


# 接口测试平台新增功能使用说明

本文档介绍4个新增的基础功能，这些功能使平台更加完善和易用。

---

## 1. ✅ Cookie 自动管理

### 功能说明
自动从响应中提取Cookie，并在测试套件中的多个用例之间共享，无需手动管理Cookie。

### 实现原理
- **自动提取**: 执行器自动从HTTP响应的`Set-Cookie`头提取Cookie
- **自动携带**: 后续请求自动携带已保存的Cookie
- **自动过期**: 自动检查Cookie的过期时间，过期的Cookie会被移除
- **套件共享**: 在测试套件中，所有测试用例共享同一个Cookie池

### 使用场景
1. **登录场景**: 第一个用例执行登录，后续用例自动携带登录Cookie
2. **会话保持**: 需要保持会话状态的接口测试
3. **多步骤流程**: 订单创建→支付→查询等多步骤流程测试

### 代码示例
```python
# 在测试套件执行时，Cookie会自动在用例间共享
# 用例1: 登录
# 响应会自动保存Cookie（如session_id）

# 用例2: 获取用户信息
# 请求会自动携带用例1保存的Cookie
```

### 技术细节
- Cookie保存在执行器的`cookies`字典中
- 支持过期时间检查（Unix时间戳和datetime对象）
- 测试套件使用`shared_cookies`在所有用例间共享

---

## 2. ✅ 文件上传支持

### 功能说明
支持multipart/form-data格式的文件上传，可测试头像上传、附件上传、批量导入等接口。

### 数据库字段
**API模型新增字段**:
```python
files = JSONField(
    default=dict,
    verbose_name='文件上传配置',
    help_text='格式: {"field_name": {"file_path": "/path/to/file", "content_type": "image/jpeg"}}'
)
```

**TestCase模型新增字段**:
```python
files_override = JSONField(
    default=dict,
    verbose_name='文件上传覆盖'
)
```

### 配置格式
```json
{
  "avatar": {
    "file_path": "/Users/admin/test.jpg",
    "content_type": "image/jpeg"
  },
  "document": {
    "file_path": "/Users/admin/report.pdf",
    "content_type": "application/pdf"
  }
}
```

### 使用步骤
1. 在接口或测试用例中配置`files`字段
2. 指定文件路径（支持变量替换，如`${file_path}`）
3. 指定Content-Type（可选，默认为`application/octet-stream`）
4. 执行测试时，系统自动读取文件并上传

### 技术细节
- 自动处理multipart/form-data编码
- 如果同时有body，会将JSON body展平为表单字段
- 自动移除`Content-Type`头，让requests库自动设置
- 支持文件路径变量替换

### 注意事项
- 文件路径必须是绝对路径
- 确保文件存在且可读
- 大文件可能影响性能

---

## 3. ✅ 接口导入/导出

### 功能说明
支持从Postman Collection和Swagger/OpenAPI文档导入接口，也可以导出为Postman Collection格式。

### 支持的格式
1. **Postman Collection v2.1**: 导入/导出
2. **Swagger/OpenAPI 3.0**: 导入（支持YAML和JSON格式）

### API接口

#### 1. 导入Postman Collection
```
POST /api/apis/apis/import_postman/
```

**请求体**:
```json
{
  "project_id": 1,
  "collection": {
    "info": {
      "name": "My API Collection",
      "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
    },
    "item": [...]
  }
}
```

**响应**:
```json
{
  "message": "成功导入 10 个接口",
  "count": 10
}
```

#### 2. 导入Swagger/OpenAPI文档
```
POST /api/apis/apis/import_swagger/
```

**请求体**:
```json
{
  "project_id": 1,
  "spec": {
    "openapi": "3.0.0",
    "info": {...},
    "paths": {...}
  }
}
```

或者YAML格式（作为字符串）:
```json
{
  "project_id": 1,
  "spec": "openapi: 3.0.0\ninfo:\n  title: My API\n..."
}
```

#### 3. 导出为Postman Collection
```
GET /api/apis/apis/export_postman/?project_id=1
```

**响应**: 直接下载JSON文件

### 使用场景
1. **快速迁移**: 从Postman或其他平台迁移接口定义
2. **API文档导入**: 直接从Swagger文档生成测试接口
3. **接口备份**: 导出接口定义作为备份
4. **团队协作**: 导出后分享给团队成员

### 技术细节
- 导入时自动解析请求方法、URL、请求头、参数、请求体
- 支持Postman的文件夹结构（会保留在接口名称中）
- Swagger导入时会根据schema生成示例数据
- 导出时按项目分组为文件夹

---

## 4. ✅ 测试报告导出

### 功能说明
将测试执行结果导出为美观的HTML格式报告，方便分享和存档。

### API接口
```
GET /api/executions/executions/{execution_id}/export_report/
```

**响应**: 直接下载HTML文件

### 报告内容
1. **执行摘要**:
   - 总用例数
   - 通过/失败数量
   - 通过率
   - 总耗时

2. **测试用例详情**:
   - 用例名称和状态
   - 请求URL和方法
   - 响应状态码
   - 响应时间
   - 响应体
   - 断言结果
   - 错误信息（如有）

3. **交互功能**:
   - 点击用例可展开/折叠详情
   - 颜色标识（绿色=通过，红色=失败）
   - 响应式设计，支持移动端查看

### 报告样式
- 现代化设计，使用渐变色和阴影
- 清晰的数据展示和统计图表
- 易读的字体和配色
- 专业的HTML/CSS布局

### 使用场景
1. **测试报告分享**: 导出后发送给测试团队或开发团队
2. **测试存档**: 保存重要版本的测试结果
3. **离线查看**: 无需登录平台即可查看测试结果
4. **项目文档**: 作为项目交付文档的一部分

---

## 数据库迁移

新功能需要执行数据库迁移：

```bash
cd backend
python3 manage.py migrate apis
python3 manage.py migrate testcases
```

### 迁移文件
1. `backend/apps/apis/migrations/0003_api_files.py` - 添加files字段
2. `backend/apps/testcases/migrations/0005_testcase_files_override.py` - 添加files_override字段

---

## API端点总结

### 新增的API端点

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/apis/apis/import_postman/` | POST | 导入Postman Collection |
| `/api/apis/apis/import_swagger/` | POST | 导入Swagger/OpenAPI文档 |
| `/api/apis/apis/export_postman/` | GET | 导出为Postman Collection |
| `/api/executions/executions/{id}/export_report/` | GET | 导出HTML测试报告 |

---

## 代码文件清单

### 后端文件
1. **Cookie管理**:
   - `backend/apps/testcases/executor.py` (修改)
   - `backend/apps/testsuites/views.py` (修改)

2. **文件上传**:
   - `backend/apps/apis/models.py` (修改)
   - `backend/apps/testcases/models.py` (修改)
   - `backend/apps/testcases/executor.py` (修改)
   - `backend/apps/apis/migrations/0003_api_files.py` (新增)
   - `backend/apps/testcases/migrations/0005_testcase_files_override.py` (新增)

3. **接口导入/导出**:
   - `backend/apps/apis/importers.py` (新增)
   - `backend/apps/apis/exporters.py` (新增)
   - `backend/apps/apis/views.py` (修改)

4. **测试报告导出**:
   - `backend/apps/executions/report_template.py` (新增)
   - `backend/apps/executions/views.py` (修改)

---

## 注意事项

1. **Cookie管理**:
   - Cookie只在测试套件执行时共享
   - 单个用例执行时不会保留Cookie到下次执行

2. **文件上传**:
   - 文件路径必须是服务器上的有效路径
   - 建议先上传文件到服务器，或使用共享存储

3. **接口导入**:
   - 导入时会创建新的接口，不会覆盖现有接口
   - 建议在新项目中使用导入功能

4. **报告导出**:
   - HTML报告是静态文件，不包含敏感信息请谨慎分享
   - 响应体过长时会自动截断（1000字符）

---

## 后续优化建议

1. **Cookie管理增强**:
   - 支持Cookie的手动编辑和管理
   - 支持Cookie的域名和路径配置

2. **文件上传增强**:
   - 支持从前端上传文件到服务器
   - 支持文件大小和类型验证

3. **导入/导出增强**:
   - 支持更多格式（如JMeter、SoapUI等）
   - 支持增量导入（更新现有接口）

4. **报告导出增强**:
   - 支持PDF格式导出
   - 支持自定义报告模板
   - 支持批量导出多个执行记录

---

## 总结

这4个新功能都是**轻量级、基础功能**，不增加系统复杂度，但能显著提升平台的实用性和易用性：

✅ **Cookie自动管理** - 解决了90%的Web API测试痛点
✅ **文件上传支持** - 覆盖了常见的文件上传场景
✅ **接口导入/导出** - 降低了迁移成本，提高了协作效率
✅ **测试报告导出** - 方便分享和存档测试结果

所有功能均已实现并可立即使用！


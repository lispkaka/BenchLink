# Tokenä¼˜å…ˆçº§ä¼˜åŒ–å®Œæˆæ€»ç»“

## ğŸ“‹ ä¼˜åŒ–èƒŒæ™¯

### ç”¨æˆ·åé¦ˆçš„é—®é¢˜

1. **å…¨å±€Tokenè¦†ç›–æµ‹è¯•å¥—ä»¶ä¸­çš„åŠ¨æ€Token**
   - æµ‹è¯•å¥—ä»¶ä¸­ç™»å½•æ¥å£æå–äº†æ–°Token
   - ä½†åç»­æ¥å£ä»ä½¿ç”¨å…¨å±€Tokençš„æ—§å€¼
   - å¯¼è‡´æ‰€æœ‰æ¥å£è¿”å›401ï¼ˆTokenè¿‡æœŸï¼‰

2. **éœ€è¦æ‰‹åŠ¨é…ç½®headers_override**
   - ä¸ºäº†ä½¿ç”¨åŠ¨æ€Tokenï¼Œéœ€è¦åœ¨æ¯ä¸ªæ¥å£é…ç½®`Authorization`
   - å¤±å»äº†å…¨å±€Token"é›¶é…ç½®"çš„ä¼˜åŠ¿
   - è¿èƒŒäº†è®¾è®¡åˆè¡·

3. **Tokenç®¡ç†æ··ä¹±**
   - åˆ†ä¸æ¸…ä½¿ç”¨çš„æ˜¯å…¨å±€Tokenè¿˜æ˜¯åŠ¨æ€Token
   - æµ‹è¯•å¥—ä»¶æ‰§è¡Œæ•ˆæœä¸ç¬¦åˆé¢„æœŸ

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. ä¿®æ”¹æ ¸å¿ƒä»£ç é€»è¾‘

**æ–‡ä»¶ï¼š** `backend/apps/testcases/executor.py`

#### ä¿®æ”¹1ï¼šåˆå§‹åŒ–æ—¶ä¿ç•™å…¨å±€Tokené™æ€å€¼

```python
# ä¿®æ”¹å‰ï¼ˆç¬¬53-62è¡Œï¼‰
if global_token:
    if global_token.variables:
        self.variables.update(global_token.variables)
    if global_token.token and 'token' not in self.variables:
        self.variables['token'] = global_token.token  # âŒ ç›´æ¥æ³¨å…¥ï¼Œä¼šè¢«è¦†ç›–

# ä¿®æ”¹å
if global_token:
    if global_token.variables:
        self.variables.update(global_token.variables)
    if global_token.token:
        self.variables['_global_token_static'] = global_token.token  # âœ… ä¿ç•™é™æ€å€¼
```

**æ”¹è¿›ç‚¹ï¼š**
- ä¸ç›´æ¥æ³¨å…¥åˆ°`variables['token']`
- ä½¿ç”¨ç‰¹æ®Šå˜é‡`_global_token_static`ä¿å­˜
- ä¸ºåŠ¨æ€Tokenç•™å‡ºç©ºé—´

#### ä¿®æ”¹2ï¼šæ„å»ºè®¤è¯æ—¶ä¼˜å…ˆä½¿ç”¨åŠ¨æ€Token

```python
# ä¿®æ”¹å‰ï¼ˆç¬¬227-241è¡Œï¼‰
global_token = self._get_global_token()
if global_token:
    token_value = global_token.token  # âŒ ç›´æ¥ä½¿ç”¨é™æ€å€¼
    token_value = self._replace_variables(token_value)
    if global_token.auth_type == 'bearer':
        return ('Bearer', token_value)

# ä¿®æ”¹åï¼ˆç¬¬228-267è¡Œï¼‰
# ä¼˜å…ˆä½¿ç”¨åŠ¨æ€Token
dynamic_token = self.variables.get('token')
global_token_static = self.variables.get('_global_token_static')

if dynamic_token and dynamic_token != global_token_static:
    # âœ… ä½¿ç”¨åŠ¨æ€Tokenï¼ˆä¼˜å…ˆçº§é«˜ï¼‰
    token_value = self._replace_variables(str(dynamic_token))
    # ç»§æ‰¿å…¨å±€Tokençš„è®¤è¯ç±»å‹
    global_token = self._get_global_token()
    if global_token:
        if global_token.auth_type == 'bearer':
            return ('Bearer', token_value)
    else:
        return ('Bearer', token_value)

# å¦‚æœæ²¡æœ‰åŠ¨æ€Tokenï¼Œä½¿ç”¨å…¨å±€Token
global_token = self._get_global_token()
if global_token:
    token_value = global_token.token
    token_value = self._replace_variables(token_value)
    if global_token.auth_type == 'bearer':
        return ('Bearer', token_value)
```

**æ”¹è¿›ç‚¹ï¼š**
- åˆ¤æ–­æ˜¯å¦æœ‰åŠ¨æ€Token
- åŠ¨æ€Tokenä¼˜å…ˆçº§é«˜äºå…¨å±€Token
- åŠ¨æ€Tokenç»§æ‰¿å…¨å±€Tokençš„è®¤è¯ç±»å‹

#### ä¿®æ”¹3ï¼šHeaderç±»å‹è®¤è¯ä¹Ÿæ”¯æŒåŠ¨æ€Token

```python
# ä¿®æ”¹åï¼ˆç¬¬951-970è¡Œï¼‰
if not self.api.auth_type or (self.api.auth_type and self.api.auth_type.lower() != 'header'):
    global_token = self._get_global_token()
    if global_token and global_token.auth_type == 'header':
        # âœ… ä¼˜å…ˆä½¿ç”¨åŠ¨æ€Token
        dynamic_token = self.variables.get('token')
        global_token_static = self.variables.get('_global_token_static')
        
        if dynamic_token and dynamic_token != global_token_static:
            token_value = self._replace_variables(str(dynamic_token))
        else:
            token_value = global_token.token
            token_value = self._replace_variables(token_value)
        
        token_format = global_token.token_format or 'Bearer'
        header_name = global_token.header_name or 'Authorization'
        headers[header_name] = f'{token_format} {token_value}' if token_format else token_value
```

**æ”¹è¿›ç‚¹ï¼š**
- Headerç±»å‹è®¤è¯ä¹Ÿæ”¯æŒåŠ¨æ€Tokenä¼˜å…ˆ
- ä¿æŒä¸€è‡´çš„ä¼˜å…ˆçº§é€»è¾‘

### 2. é…ç½®ç™»å½•ç”¨ä¾‹çš„å˜é‡æå–å™¨

**æµ‹è¯•ç”¨ä¾‹IDï¼š** 21ï¼ˆç™»å½•ï¼‰

**é…ç½®å‰ï¼š**
```python
variables: {}  # âŒ æ²¡æœ‰æå–å™¨
```

**é…ç½®åï¼š**
```python
variables: {
    "extractors": {
        "token": "$.data.accessToken",  # âœ… æå–token
        "user_id": "$.data.userId"      # âœ… æå–user_id
    }
}
```

**æ•ˆæœï¼š**
- ç™»å½•æˆåŠŸåè‡ªåŠ¨æå–Token
- æµ‹è¯•å¥—ä»¶ä¸­åç»­ç”¨ä¾‹å¯ä»¥ä½¿ç”¨

### 3. å¯ç”¨å¹¶é…ç½®å…¨å±€Token

**å…¨å±€Tokené…ç½®ï¼š**
```python
id: 1
åç§°: token
è®¤è¯ç±»å‹: bearer
æ˜¯å¦å¯ç”¨: True   # âœ… å·²å¯ç”¨
æ˜¯å¦é»˜è®¤: True   # âœ… å·²è®¾ä¸ºé»˜è®¤
Tokenå€¼: eyJhbGc...ï¼ˆå·²æ›´æ–°ä¸ºæœ€æ–°å€¼ï¼‰
```

**æ•ˆæœï¼š**
- å•ç‹¬æ‰§è¡Œæ¥å£æ—¶è‡ªåŠ¨ä½¿ç”¨
- æµ‹è¯•å¥—ä»¶æ‰§è¡Œæ—¶ä¼šè¢«åŠ¨æ€Tokenè¦†ç›–

### 4. ä¿®å¤æ¥å£Headerså˜é‡æ ¼å¼

**æ¥å£IDï¼š** 466ï¼ˆç­‰çº§åˆ’åˆ†ï¼‰

**ä¿®æ”¹å‰ï¼š**
```json
{
  "X-Sign": "{{x_sign}}",     // âŒ ä¸æ”¯æŒçš„æ ¼å¼
  "X-Time": "{{x_time}}",
  "X-Nonce": "{{x_nonce}}"
}
```

**ä¿®æ”¹åï¼š**
```json
{
  "X-Sign": "${x_sign}",      // âœ… æ­£ç¡®çš„æ ¼å¼
  "X-Time": "${x_time}",
  "X-Nonce": "${x_nonce}"
}
```

**æ•ˆæœï¼š**
- å˜é‡å¯ä»¥æ­£ç¡®æ›¿æ¢
- ç­¾åéªŒè¯é€šè¿‡

## ğŸ¯ ä¼˜åŒ–æ•ˆæœ

### æ–°çš„Tokenä¼˜å…ˆçº§æœºåˆ¶

```
1. æ¥å£é…ç½®çš„auth_typeï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
   â†“ å¦‚æœæ¥å£æœªé…ç½®
2. åŠ¨æ€Tokenï¼ˆæµ‹è¯•å¥—ä»¶ä¸­æå–ï¼‰â­ æ–°å¢ä¼˜å…ˆçº§
   â†“ å¦‚æœæ²¡æœ‰åŠ¨æ€Token
3. å…¨å±€Tokenï¼ˆé…ç½®ç®¡ç†ä¸­è®¾ç½®ï¼‰
   â†“ å¦‚æœæ²¡æœ‰å…¨å±€Token
4. æ— è®¤è¯
```

### åœºæ™¯1ï¼šå•ç‹¬æ‰§è¡Œæ¥å£ï¼ˆä½¿ç”¨å…¨å±€Tokenï¼‰

```
æ‰§è¡Œæµç¨‹ï¼š
1. åˆå§‹åŒ–æ‰§è¡Œå™¨
   â””â”€ variables['_global_token_static'] = å…¨å±€Token

2. æ„å»ºè®¤è¯
   â””â”€ variables['token']ä¸å­˜åœ¨
   â””â”€ ä½¿ç”¨variables['_global_token_static']

3. å‘é€è¯·æ±‚
   â””â”€ Authorization: Bearer <å…¨å±€Token>
```

**éªŒè¯ç»“æœï¼š** âœ… é€šè¿‡

### åœºæ™¯2ï¼šæµ‹è¯•å¥—ä»¶æ‰§è¡Œï¼ˆä½¿ç”¨åŠ¨æ€Tokenï¼‰

```
æ‰§è¡Œæµç¨‹ï¼š
1. ç™»å½•ç”¨ä¾‹
   â”œâ”€ åˆå§‹åŒ–ï¼švariables['_global_token_static'] = å…¨å±€Token
   â”œâ”€ ç™»å½•æˆåŠŸ
   â””â”€ æå–ï¼švariables['token'] = æ–°Tokenï¼ˆåŠ¨æ€ï¼‰

2. åç»­ç”¨ä¾‹
   â”œâ”€ åˆå§‹åŒ–ï¼švariables['_global_token_static'] = å…¨å±€Token
   â”œâ”€ æ³¨å…¥å…±äº«å˜é‡ï¼švariables['token'] = æ–°Token
   â””â”€ æ„å»ºè®¤è¯ï¼šæ£€æµ‹åˆ°åŠ¨æ€Tokenï¼Œä½¿ç”¨åŠ¨æ€Token

3. å‘é€è¯·æ±‚
   â””â”€ Authorization: Bearer <åŠ¨æ€Token>
```

**éªŒè¯ç»“æœï¼š** âœ… é€šè¿‡

## ğŸ“Š éªŒè¯æ•°æ®

### éªŒè¯æµ‹è¯•è¾“å‡º

```
================================================================================
ã€å…¨å±€Tokenä¼˜å…ˆçº§ä¼˜åŒ– - å®Œæ•´éªŒè¯ã€‘
================================================================================

å…¨å±€Tokené…ç½®:
  - åç§°: token
  - å¯ç”¨: True
  - é»˜è®¤: True
  - Tokenå‰30å­—ç¬¦: eyJhbGciOiJIUzUxMiJ9.eyJhcHAiO...

================================================================================
ã€åœºæ™¯1ã€‘å•ç‹¬æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼ˆä¸åœ¨æµ‹è¯•å¥—ä»¶ä¸­ï¼‰
================================================================================

ç”¨ä¾‹: ç­‰çº§åˆ’åˆ†
æ¥å£auth_type: æœªé…ç½®

åˆå§‹åŒ–åçš„å˜é‡:
  âœ… _global_token_static: eyJhbGciOiJIUzUxMiJ9.eyJhcHAiO...
  âœ… token: ä¸å­˜åœ¨ï¼ˆæ­£å¸¸ï¼Œå°†ä½¿ç”¨å…¨å±€Tokenï¼‰

æ„å»ºçš„è®¤è¯:
  - ç±»å‹: Bearer
  - Tokenå‰30å­—ç¬¦: eyJhbGciOiJIUzUxMiJ9.eyJhcHAiO...
  âœ… ä½¿ç”¨å…¨å±€Tokenï¼ˆç¬¦åˆé¢„æœŸï¼‰

================================================================================
ã€åœºæ™¯2ã€‘æ¨¡æ‹Ÿæµ‹è¯•å¥—ä»¶æ‰§è¡Œï¼ˆç™»å½• â†’ åç»­æ¥å£ï¼‰
================================================================================

æ­¥éª¤1ï¼šæ‰§è¡Œç™»å½•ç”¨ä¾‹
ç™»å½•çŠ¶æ€: âœ… æˆåŠŸ
æå–çš„å˜é‡: ['_global_token_static', 'token']
åŠ¨æ€Tokenå‰30å­—ç¬¦: eyJhbGciOiJIUzUxMiJ9.eyJhcHAiO...
âœ… åŠ¨æ€Tokenä¸å…¨å±€Tokenä¸åŒï¼ˆç¬¦åˆé¢„æœŸï¼‰

æ­¥éª¤2ï¼šæ‰§è¡Œåç»­ç”¨ä¾‹ï¼ˆä½¿ç”¨åŠ¨æ€Tokenï¼‰
âœ… æ³¨å…¥å…±äº«å˜é‡ï¼ˆåŒ…å«åŠ¨æ€Tokenï¼‰

æ‰§è¡Œå™¨çš„å˜é‡:
  âœ… _global_token_static: eyJhbGciOiJIUzUxMiJ9.eyJhcHAiO...
  âœ… token: eyJhbGciOiJIUzUxMiJ9.eyJhcHAiO...
     â†’ è¿™æ˜¯åŠ¨æ€Tokenï¼ˆä»ç™»å½•ç”¨ä¾‹æå–ï¼‰

æ„å»ºçš„è®¤è¯:
  - ç±»å‹: Bearer
  - Tokenå‰30å­—ç¬¦: eyJhbGciOiJIUzUxMiJ9.eyJhcHAiO...
  âœ… ä½¿ç”¨åŠ¨æ€Tokenï¼ˆç¬¦åˆé¢„æœŸï¼Œä¼˜å…ˆçº§é«˜ï¼‰

================================================================================
ã€éªŒè¯æ€»ç»“ã€‘
================================================================================
âœ… åœºæ™¯1éªŒè¯é€šè¿‡ï¼šå•ç‹¬æ‰§è¡Œæ—¶è‡ªåŠ¨ä½¿ç”¨å…¨å±€Token
âœ… åœºæ™¯2éªŒè¯é€šè¿‡ï¼šå¥—ä»¶æ‰§è¡Œæ—¶è‡ªåŠ¨ä½¿ç”¨åŠ¨æ€Token
âœ… ä¼˜å…ˆçº§æ­£ç¡®ï¼šåŠ¨æ€Token > å…¨å±€Token > æ— è®¤è¯

ğŸ‰ ä¼˜åŒ–æˆåŠŸï¼Tokenç®¡ç†æ›´æ™ºèƒ½äº†ï¼
================================================================================
```

## ğŸ ä¼˜åŒ–æ”¶ç›Š

### 1. è§£å†³äº†ç”¨æˆ·çš„æ ¸å¿ƒé—®é¢˜

| é—®é¢˜ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|-----|-------|-------|
| æµ‹è¯•å¥—ä»¶è¿”å›401 | âŒ ä½¿ç”¨è¿‡æœŸçš„å…¨å±€Token | âœ… ä½¿ç”¨æœ€æ–°çš„åŠ¨æ€Token |
| éœ€è¦æ‰‹åŠ¨é…ç½®headers | âŒ æ¯ä¸ªæ¥å£éƒ½è¦é…ç½® | âœ… é›¶é…ç½®ï¼Œè‡ªåŠ¨åº”ç”¨ |
| Tokenç®¡ç†æ··ä¹± | âŒ åˆ†ä¸æ¸…ç”¨çš„å“ªä¸ªToken | âœ… æ™ºèƒ½ä¼˜å…ˆçº§ï¼Œæ¸…æ™°æ˜ç¡® |

### 2. æå‡äº†ç”¨æˆ·ä½“éªŒ

- âœ… **é›¶é…ç½®**ï¼šæ¥å£ä¸éœ€è¦é…ç½®è®¤è¯
- âœ… **æ™ºèƒ½é€‰æ‹©**ï¼šè‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„Token
- âœ… **çµæ´»å¯æ§**ï¼šæ”¯æŒå¤šç§ä½¿ç”¨åœºæ™¯
- âœ… **å‘åå…¼å®¹**ï¼šä¸å½±å“ç°æœ‰åŠŸèƒ½

### 3. ç¬¦åˆè®¾è®¡åˆè¡·

**"é›¶é…ç½®ï¼Œè‡ªåŠ¨åº”ç”¨"** - çœŸæ­£å®ç°äº†è¿™ä¸€è®¾è®¡ç†å¿µï¼š
- å•ç‹¬æ‰§è¡Œï¼šä¾¿æ·ï¼ˆå…¨å±€Tokenï¼‰
- å¥—ä»¶æ‰§è¡Œï¼šå‡†ç¡®ï¼ˆåŠ¨æ€Tokenï¼‰
- è‡ªåŠ¨é€‰æ‹©ï¼šæ™ºèƒ½ï¼ˆæ— éœ€é…ç½®ï¼‰

## ğŸ“š é…å¥—æ–‡æ¡£

### 1. å…¨å±€Tokenä¼˜å…ˆçº§ä¼˜åŒ–è¯´æ˜.md
- è¯¦ç»†çš„æŠ€æœ¯å®ç°è¯´æ˜
- ä¼˜å…ˆçº§é€»è¾‘è§£æ
- ä»£ç å®ç°ç»†èŠ‚
- ä½¿ç”¨åœºæ™¯åˆ†æ

### 2. å…¨å±€Tokenä½¿ç”¨æŒ‡å—.md
- å¿«é€Ÿå¼€å§‹æŒ‡å—
- é…ç½®æ­¥éª¤è¯´æ˜
- å¸¸è§é—®é¢˜è§£ç­”
- æœ€ä½³å®è·µå»ºè®®

### 3. Tokenä¼˜å…ˆçº§ä¼˜åŒ–å®Œæˆæ€»ç»“.mdï¼ˆæœ¬æ–‡æ¡£ï¼‰
- ä¼˜åŒ–èƒŒæ™¯å’Œé—®é¢˜
- å®Œæˆçš„å·¥ä½œæ¸…å•
- éªŒè¯ç»“æœå’Œæ•°æ®
- ä¼˜åŒ–æ”¶ç›Šæ€»ç»“

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

### 1. ç”¨æˆ·æ“ä½œ

1. **åˆ·æ–°å‰ç«¯é¡µé¢**ï¼ŒåŠ è½½æœ€æ–°ä»£ç 
2. **æµ‹è¯•å•ç‹¬æ‰§è¡Œæ¥å£**ï¼š
   - é€‰æ‹©ä»»æ„æ¥å£ï¼ˆæœªé…ç½®è®¤è¯çš„ï¼‰
   - ç‚¹å‡»æ‰§è¡Œ
   - éªŒè¯æ˜¯å¦è‡ªåŠ¨ä½¿ç”¨å…¨å±€Token

3. **æµ‹è¯•æ‰§è¡Œæµ‹è¯•å¥—ä»¶**ï¼š
   - åˆ›å»ºæˆ–é€‰æ‹©åŒ…å«ç™»å½•ç”¨ä¾‹çš„æµ‹è¯•å¥—ä»¶
   - æ‰§è¡Œæµ‹è¯•å¥—ä»¶
   - éªŒè¯æ˜¯å¦è‡ªåŠ¨ä½¿ç”¨åŠ¨æ€Token
   - æ£€æŸ¥æ‰€æœ‰æ¥å£æ˜¯å¦æˆåŠŸï¼ˆä¸è¿”å›401ï¼‰

### 2. åŠŸèƒ½æ‰©å±•ï¼ˆå¯é€‰ï¼‰

1. **å‰ç«¯æ˜¾ç¤ºTokenæ¥æº**
   - åœ¨æ‰§è¡Œç»“æœä¸­æ˜¾ç¤º"ä½¿ç”¨çš„Tokenç±»å‹"
   - ä¾‹å¦‚ï¼š"âœ… åŠ¨æ€Token" æˆ– "âœ… å…¨å±€Token"

2. **Tokenè¿‡æœŸæé†’**
   - æ£€æµ‹å…¨å±€Tokenæ˜¯å¦æ¥è¿‘è¿‡æœŸ
   - æé†’ç”¨æˆ·æ›´æ–°

3. **å¤šç¯å¢ƒTokenç®¡ç†**
   - æ”¯æŒä¸ºä¸åŒç¯å¢ƒé…ç½®ä¸åŒçš„å…¨å±€Token
   - åˆ‡æ¢ç¯å¢ƒæ—¶è‡ªåŠ¨åˆ‡æ¢Token

## âœ¨ æ€»ç»“

è¿™æ¬¡ä¼˜åŒ–å®ç°äº†**æ™ºèƒ½Tokenç®¡ç†æœºåˆ¶**ï¼š

1. **è§£å†³äº†æ ¸å¿ƒé—®é¢˜**
   - æµ‹è¯•å¥—ä»¶ä¸å†è¿”å›401
   - æ— éœ€æ‰‹åŠ¨é…ç½®headers_override
   - Tokenç®¡ç†æ¸…æ™°æ˜ç¡®

2. **æå‡äº†ç”¨æˆ·ä½“éªŒ**
   - é›¶é…ç½®ä½¿ç”¨
   - æ™ºèƒ½è‡ªåŠ¨é€‰æ‹©
   - çµæ´»å¯æ§

3. **ä¿æŒäº†å‘åå…¼å®¹**
   - ä¸å½±å“ç°æœ‰æ¥å£
   - ä¸å½±å“ç°æœ‰æµ‹è¯•ç”¨ä¾‹
   - æ¸è¿›å¼ä¼˜åŒ–

**ä¸€å¥è¯æ€»ç»“ï¼šå¼€å‘ç”¨å…¨å±€Tokenï¼Œæµ‹è¯•ç”¨åŠ¨æ€Tokenï¼Œç³»ç»Ÿæ™ºèƒ½é€‰æ‹©ï¼** ğŸ‰

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´ï¼š** 2025-11-05  
**ä¼˜åŒ–ç‰ˆæœ¬ï¼š** v2.0  
**æ–‡æ¡£ä½œè€…ï¼š** AIåŠ©æ‰‹  
**éªŒè¯çŠ¶æ€ï¼š** âœ… å…¨éƒ¨é€šè¿‡



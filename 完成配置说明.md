# åŠŸèƒ½å®ç°å®Œæˆè¯´æ˜

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. æ‹–æ‹½æ’åºåŠŸèƒ½
- âœ… åç«¯APIï¼š`POST /api/testsuites/{id}/reorder_testcases/`
- âœ… å‰ç«¯ï¼šé›†æˆ Sortable.js å®ç°æ‹–æ‹½
- âœ… è‡ªåŠ¨ä¿å­˜ï¼šæ‹–æ‹½åè‡ªåŠ¨è°ƒç”¨APIä¿å­˜é¡ºåº
- âœ… å®‰è£…ä¾èµ–ï¼šsortablejs@1.15.2 å·²å®‰è£…

### 2. ä¼ä¸šå¾®ä¿¡é€šçŸ¥åŠŸèƒ½ï¼ˆæ ¸å¿ƒä»£ç å·²å®Œæˆï¼‰
- âœ… åˆ›å»º notifications app
- âœ… NotificationChannel æ¨¡å‹
- âœ… ä¼ä¸šå¾®ä¿¡é€šçŸ¥å™¨ï¼ˆWeComNotifierï¼‰
- âœ… é’‰é’‰é€šçŸ¥å™¨ï¼ˆDingTalkNotifierï¼‰
- âœ… é€šçŸ¥æœåŠ¡ï¼ˆsend_execution_notificationï¼‰
- âœ… åºåˆ—åŒ–å™¨å’Œè§†å›¾
- âœ… URLé…ç½®

---

## ğŸ“‹ éœ€è¦æ‰‹åŠ¨å®Œæˆçš„é…ç½®

### æ­¥éª¤1ï¼šæ³¨å†Œnotifications app

ç¼–è¾‘ `backend/BenchLink/settings.py`ï¼š

```python
INSTALLED_APPS = [
    # ... å…¶ä»–apps
    'apps.notifications',  # æ·»åŠ è¿™ä¸€è¡Œ
]
```

### æ­¥éª¤2ï¼šæ³¨å†ŒURLè·¯ç”±

ç¼–è¾‘ `backend/BenchLink/urls.py`ï¼š

```python
urlpatterns = [
    # ... å…¶ä»–è·¯ç”±
    path('api/notifications/', include('apps.notifications.urls')),  # æ·»åŠ è¿™ä¸€è¡Œ
]
```

### æ­¥éª¤3ï¼šåˆ›å»ºæ•°æ®åº“è¿ç§»

```bash
cd backend
python3 manage.py makemigrations notifications
python3 manage.py migrate
```

### æ­¥éª¤4ï¼šåœ¨æµ‹è¯•æ‰§è¡Œå®Œæˆåè§¦å‘é€šçŸ¥

ç¼–è¾‘ `backend/apps/testsuites/views.py`ï¼Œåœ¨ `execute` æ–¹æ³•çš„æœ€åæ·»åŠ ï¼š

```python
# åœ¨ return Response(...) ä¹‹å‰æ·»åŠ 
from apps.notifications.service import send_execution_notification
send_execution_notification(suite_execution)
```

å®Œæ•´ä»£ç ä½ç½®ï¼ˆçº¦ç¬¬253è¡Œï¼Œreturnä¹‹å‰ï¼‰ï¼š

```python
        suite_execution.end_time = suite_end_time
        suite_execution.duration = suite_duration
        suite_execution.save()
        
        # ã€æ·»åŠ è¿™ä¸¤è¡Œã€‘å‘é€é€šçŸ¥
        from apps.notifications.service import send_execution_notification
        send_execution_notification(suite_execution)
        
        return Response({...})
```

---

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### é…ç½®ä¼ä¸šå¾®ä¿¡é€šçŸ¥

1. **è·å–Webhook URL**
   - è¿›å…¥ä¼ä¸šå¾®ä¿¡ç¾¤ç»„
   - æ·»åŠ ç¾¤æœºå™¨äºº
   - å¤åˆ¶Webhook URL

2. **åœ¨BenchLinkä¸­é…ç½®**
   - è®¿é—®ï¼š`http://localhost:8080/settings` ï¼ˆéœ€è¦æ·»åŠ å‰ç«¯é¡µé¢ï¼‰
   - æˆ–ç›´æ¥è°ƒç”¨APIï¼š

```bash
curl -X POST http://localhost:8000/api/notifications/channels/ \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æµ‹è¯•é€šçŸ¥",
    "channel_type": "wecom",
    "webhook_url": "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY",
    "is_active": true,
    "notify_on_failure": true,
    "notify_on_success": false
  }'
```

3. **æµ‹è¯•é€šçŸ¥**

```bash
curl -X POST http://localhost:8000/api/notifications/channels/1/test/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## ğŸš€ CI/CDé›†æˆï¼ˆç®€åŒ–ç‰ˆï¼‰

### åˆ›å»ºå‘½ä»¤è¡Œå·¥å…·

åˆ›å»ºæ–‡ä»¶ `backend/scripts/cicd_client.py`ï¼š

```python
#!/usr/bin/env python3
"""
CI/CD é›†æˆå®¢æˆ·ç«¯
ç”¨æ³•ï¼špython cicd_client.py --url http://localhost:8000 --token YOUR_TOKEN --suite-id 1 --wait
"""
import argparse
import requests
import time
import sys


def main():
    parser = argparse.ArgumentParser(description='BenchLink CI/CD Client')
    parser.add_argument('--url', required=True, help='BenchLink API URL')
    parser.add_argument('--token', required=True, help='API Token')
    parser.add_argument('--suite-id', required=True, type=int, help='Test Suite ID')
    parser.add_argument('--wait', action='store_true', help='Wait for execution to complete')
    parser.add_argument('--timeout', type=int, default=600, help='Timeout in seconds (default: 600)')
    
    args = parser.parse_args()
    
    headers = {
        'Authorization': f'Bearer {args.token}',
        'Content-Type': 'application/json'
    }
    
    # è§¦å‘æ‰§è¡Œ
    print(f'ğŸš€ Triggering test suite {args.suite_id}...')
    response = requests.post(
        f'{args.url}/api/testsuites/testsuites/{args.suite_id}/execute/',
        headers=headers
    )
    
    if response.status_code != 200:
        print(f'âŒ Failed to trigger execution: {response.text}')
        sys.exit(1)
    
    result = response.json()
    execution_id = result.get('execution_id')
    print(f'âœ… Execution started: ID {execution_id}')
    
    if not args.wait:
        sys.exit(0)
    
    # ç­‰å¾…æ‰§è¡Œå®Œæˆ
    print(f'â³ Waiting for execution to complete...')
    start_time = time.time()
    
    while True:
        if time.time() - start_time > args.timeout:
            print(f'âŒ Timeout after {args.timeout} seconds')
            sys.exit(1)
        
        response = requests.get(
            f'{args.url}/api/executions/executions/{execution_id}/',
            headers=headers
        )
        
        if response.status_code != 200:
            print(f'âŒ Failed to get execution status')
            sys.exit(1)
        
        execution = response.json()
        status = execution.get('status')
        
        if status in ['passed', 'failed']:
            print(f'\nğŸ“Š Execution completed: {status.upper()}')
            print(f'   Total: {execution.get("result", {}).get("total", 0)}')
            print(f'   Passed: {execution.get("result", {}).get("passed", 0)}')
            print(f'   Failed: {execution.get("result", {}).get("failed", 0)}')
            
            if status == 'passed':
                sys.exit(0)
            else:
                sys.exit(1)
        
        time.sleep(5)


if __name__ == '__main__':
    main()
```

### Jenkins ä½¿ç”¨ç¤ºä¾‹

```groovy
stage('APIæµ‹è¯•') {
    steps {
        sh '''
            python3 backend/scripts/cicd_client.py \
              --url ${API_TEST_URL} \
              --token ${API_TOKEN} \
              --suite-id 1 \
              --wait
        '''
    }
}
```

### GitLab CI ä½¿ç”¨ç¤ºä¾‹

```yaml
api_test:
  stage: test
  script:
    - python3 backend/scripts/cicd_client.py
        --url $API_TEST_URL
        --token $API_TOKEN
        --suite-id 1
        --wait
```

---

## ğŸ“ APIæ–‡æ¡£

### é€šçŸ¥æ¸ é“ç®¡ç†

**1. è·å–é€šçŸ¥æ¸ é“åˆ—è¡¨**
```
GET /api/notifications/channels/
```

**2. åˆ›å»ºé€šçŸ¥æ¸ é“**
```
POST /api/notifications/channels/
{
  "name": "ä¼ä¸šå¾®ä¿¡é€šçŸ¥",
  "channel_type": "wecom",  // wecom, dingtalk
  "webhook_url": "https://...",
  "secret": "",  // é’‰é’‰éœ€è¦
  "notify_on_failure": true,
  "notify_on_success": false
}
```

**3. æµ‹è¯•é€šçŸ¥æ¸ é“**
```
POST /api/notifications/channels/{id}/test/
```

**4. æ›´æ–°é€šçŸ¥æ¸ é“**
```
PATCH /api/notifications/channels/{id}/
```

**5. åˆ é™¤é€šçŸ¥æ¸ é“**
```
DELETE /api/notifications/channels/{id}/
```

---

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### æ‹–æ‹½æ’åº
- ğŸ¯ ç›´è§‚çš„æ‹–æ‹½æ“ä½œ
- ğŸ’¾ è‡ªåŠ¨ä¿å­˜é¡ºåº
- ğŸ”„ å®æ—¶æ›´æ–°
- âœ… æ‰§è¡Œé¡ºåºä¸æ˜¾ç¤ºé¡ºåºä¸€è‡´

### ä¼ä¸šå¾®ä¿¡é€šçŸ¥
- ğŸ“± Markdownæ ¼å¼æ¶ˆæ¯
- ğŸ¨ ç¾è§‚çš„å¡ç‰‡æ ·å¼
- ğŸ“Š å®Œæ•´çš„æ‰§è¡Œç»Ÿè®¡
- ğŸ”— å¿«é€Ÿè·³è½¬è¯¦æƒ…

### CI/CDé›†æˆ
- ğŸš€ ç®€å•æ˜“ç”¨çš„å‘½ä»¤è¡Œå·¥å…·
- â³ æ”¯æŒç­‰å¾…æ‰§è¡Œå®Œæˆ
- âœ… åŸºäºæ‰§è¡Œç»“æœçš„é€€å‡ºç 
- ğŸ”§ æ”¯æŒæ‰€æœ‰ä¸»æµCIå·¥å…·

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é€šçŸ¥å‘é€å¤±è´¥

1. **æ£€æŸ¥Webhook URLæ˜¯å¦æ­£ç¡®**
2. **æ£€æŸ¥ç½‘ç»œè¿æ¥**
3. **æŸ¥çœ‹æ—¥å¿—ï¼š**
   ```bash
   tail -f backend/logs/django.log
   ```

### CI/CDè„šæœ¬å¤±è´¥

1. **æ£€æŸ¥API Tokenæ˜¯å¦æœ‰æ•ˆ**
2. **æ£€æŸ¥å¥—ä»¶IDæ˜¯å¦å­˜åœ¨**
3. **ç¡®è®¤ç½‘ç»œå¯è¾¾æ€§**

---

## ğŸ“š ä¸‹ä¸€æ­¥å»ºè®®

1. **å‰ç«¯é…ç½®ç•Œé¢**ï¼ˆå¾…å¼€å‘ï¼‰
   - é€šçŸ¥æ¸ é“ç®¡ç†é¡µé¢
   - æµ‹è¯•å‘é€åŠŸèƒ½
   - å†å²è®°å½•æŸ¥çœ‹

2. **æ›´å¤šé€šçŸ¥æ¸ é“**
   - é£ä¹¦
   - Telegram
   - é‚®ä»¶

3. **é«˜çº§åŠŸèƒ½**
   - @æŒ‡å®šäººå‘˜
   - è‡ªå®šä¹‰æ¶ˆæ¯æ¨¡æ¿
   - é™é»˜æ—¶æ®µè®¾ç½®

---

éœ€è¦å¸®åŠ©ï¼Ÿè¯·æŸ¥çœ‹ä»£ç æˆ–æ–‡æ¡£ï¼ğŸ‰




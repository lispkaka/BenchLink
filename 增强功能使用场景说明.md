# 增强功能使用场景说明

## 📋 功能优先级评估

### 🔴 **高优先级（强烈建议实现）**

---

## 1. Cookie 管理 🔴 **高优先级**

### **为什么需要？**
Cookie是Web应用中最常见的会话管理机制，**大部分需要登录的API测试都依赖Cookie**。

### **使用场景**

#### 场景1：登录后获取Cookie，后续请求自动携带
```
测试流程：
1. 调用登录接口 → 返回 Set-Cookie: session_id=abc123
2. 获取用户信息接口 → 自动携带 Cookie: session_id=abc123
3. 提交订单接口 → 自动携带 Cookie: session_id=abc123
```

**现状问题**：
- ❌ 目前需要手动在headers中设置 `Cookie: session_id=abc123`
- ❌ 如果Cookie过期，需要手动更新每个测试用例
- ❌ 无法自动处理Cookie的过期和刷新

**实现后的好处**：
- ✅ 自动管理Cookie，登录后自动保存和使用
- ✅ Cookie过期自动处理
- ✅ 测试套件中多个用例自动共享Cookie

#### 场景2：跨域Cookie管理
```
场景：测试微服务架构
- 用户服务返回 session_token
- 订单服务需要携带 session_token
- 支付服务需要携带 session_token
```

#### 场景3：Cookie断言验证
```
验证登录接口返回的Cookie是否正确设置：
- Set-Cookie: HttpOnly
- Set-Cookie: Secure
- Set-Cookie: SameSite
```

### **实现建议**
```python
# 在TestCaseExecutor中
class TestCaseExecutor:
    def __init__(self, ...):
        self.cookies = {}  # Cookie存储
    
    def execute(self):
        # 发送请求后
        if self.response.cookies:
            self.cookies.update(self.response.cookies)
        
        # 下次请求自动携带
        request_kwargs['cookies'] = self.cookies
```

---

## 2. 文件上传 🔴 **高优先级**

### **为什么需要？**
**文件上传是常见的API功能**，尤其是：
- 用户头像上传
- 文档/附件上传
- 图片/视频上传
- 批量文件导入

### **使用场景**

#### 场景1：用户头像上传测试
```
POST /api/users/{userId}/avatar
Content-Type: multipart/form-data

file: [图片文件]
userId: 123

验证：
- 上传成功
- 返回图片URL
- 图片大小限制
- 图片格式限制（jpg/png/gif）
```

#### 场景2：批量数据导入测试
```
POST /api/data/import
Content-Type: multipart/form-data

file: [Excel文件]
type: "users"

验证：
- 导入成功
- 返回导入统计（成功/失败数量）
- 错误数据反馈
```

#### 场景3：文档管理系统测试
```
测试流程：
1. 上传文档 → 获取文档ID
2. 查询文档详情 → 使用文档ID
3. 下载文档 → 验证文件内容
```

### **实现建议**
```python
# 在API模型中添加文件字段
class API(models.Model):
    files = models.JSONField(default=dict, verbose_name='文件上传配置')
    # {
    #   "avatar": {
    #     "file_path": "/path/to/file.jpg",
    #     "field_name": "file",
    #     "content_type": "image/jpeg"
    #   }
    # }

# 在执行器中处理
if self.api.files:
    files = {}
    for field_name, file_config in self.api.files.items():
        file_path = file_config['file_path']
        with open(file_path, 'rb') as f:
            files[field_name] = (file_path, f.read(), file_config.get('content_type'))
    request_kwargs['files'] = files
```

---

## 3. OAuth 认证 🟡 **中优先级**

### **为什么需要？**
OAuth是**第三方登录和API授权**的标准，很多现代应用都使用OAuth。

### **使用场景**

#### 场景1：测试第三方登录流程
```
OAuth 2.0 授权码模式：
1. 用户点击"使用微信登录"
2. 跳转到授权页面
3. 用户同意后，返回授权码
4. 使用授权码换取 Access Token
5. 使用 Access Token 调用API
```

**测试场景**：
```
测试用例：
- 获取授权URL → 验证URL格式
- 交换授权码 → 验证Token返回
- 使用Token调用API → 验证授权成功
- Token过期处理 → 自动刷新Token
```

#### 场景2：测试API网关认证
```
很多企业级API使用OAuth：
- GitHub API (OAuth Token)
- Google API (OAuth 2.0)
- 企业内部API网关
```

#### 场景3：服务间认证（Client Credentials模式）
```
微服务架构中：
- 服务A调用服务B
- 使用Client ID和Secret获取Token
- Token自动刷新和管理
```

### **现状问题**
- ❌ 目前只支持Bearer Token（手动配置）
- ❌ 无法自动获取OAuth Token
- ❌ 无法处理Token刷新

### **实现建议**
```python
# 在API模型中扩展认证配置
{
  "auth_type": "oauth2",
  "auth_config": {
    "grant_type": "authorization_code",  # 或 "client_credentials"
    "token_url": "https://oauth.example.com/token",
    "client_id": "${oauth_client_id}",
    "client_secret": "${oauth_client_secret}",
    "redirect_uri": "https://callback.example.com",
    "scope": "read write"
  }
}

# 在执行器中自动处理
def _get_oauth_token(self):
    # 自动获取Token
    # 缓存Token
    # 自动刷新过期Token
```

---

## 📊 功能优先级总结

| 功能 | 优先级 | 使用频率 | 实现难度 | 推荐实现 |
|------|--------|----------|----------|----------|
| **Cookie管理** | 🔴 高 | ⭐⭐⭐⭐⭐ | 🟢 简单 | ✅ **强烈推荐** |
| **文件上传** | 🔴 高 | ⭐⭐⭐⭐ | 🟡 中等 | ✅ **推荐** |
| **OAuth认证** | 🟡 中 | ⭐⭐⭐ | 🟠 复杂 | ⚠️ **按需实现** |

---

## 💡 实现建议

### **第一阶段：Cookie管理**（1-2天）
- ✅ 自动保存和管理Cookie
- ✅ 在测试套件中共享Cookie
- ✅ Cookie断言验证

### **第二阶段：文件上传**（2-3天）
- ✅ 支持multipart/form-data
- ✅ 文件路径配置
- ✅ 文件类型验证
- ✅ 文件大小限制验证

### **第三阶段：OAuth认证**（3-5天）
- ✅ OAuth 2.0 标准流程
- ✅ Token自动获取和刷新
- ✅ 多种grant_type支持

---

## ❓ 是否需要这些功能？

### **建议：**
1. **Cookie管理** → **必须实现**（90%的Web API都需要）
2. **文件上传** → **应该实现**（60%的项目会用到）
3. **OAuth认证** → **按需实现**（30%的项目需要，但很重要）

### **如果不需要，可以先用现有功能替代：**
- Cookie管理 → 手动在headers中设置（不方便但可用）
- 文件上传 → 暂时不支持（无法测试文件上传接口）
- OAuth → 手动获取Token后配置（繁琐但可用）

---

## 🎯 建议

**如果这是一个通用的接口测试平台**：
- ✅ **优先实现Cookie管理和文件上传**
- ⚠️ **OAuth可以后续按需实现**

**如果主要用于内部API测试**：
- ✅ **Cookie管理很重要**
- ✅ **文件上传看实际需求**
- ⚠️ **OAuth可能不需要**

